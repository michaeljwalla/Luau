local function addzeros(str, untilLen)
    while #str < untilLen do
        str = '0'..str
    end
    return str
end
local function wasRedirected(str)
    local s, e = str:find"<head>.*</head>"
    str = str:sub(s, e)return (str:find("<title>にゃんこ大戦争データベース</title>") ~= nil), e+1 --title of homepage (redirects here when 404ing)
end
local function fetchwebp(wholeMap, map, stage)
    map = tostring(map)
    stage = tostring(stage)
    local url = 'https://battlecats-db.com/stage/s'..addzeros(map, 5)..(not wholeMap and '-'..addzeros(stage, 2) or '')..'.html'
    setclipboard(url)
    local data = syn.request{
        Method = 'GET',
        Url = url
    }
    return data, {wasRedirected(data.Body or "")}, not stage
end
local function getcontents(str)
    str = str:match("<div class=\"maincontents\".*</table></div>")
    
    return str and str:sub(27,-7)
end

local function contentify(map, stage)
    local data, rdir, loadMap = fetchwebp(not stage, map, stage)
    assert(data.StatusCode == 200, "HTTP Error? Code "..data.StatusCode)
    assert(not rdir[1], "\n-----------------------------\n\tInvalid map/stage code...\n\t\tMap: "..tostring(map)..(stage and "\n\t\tStage: "..tostring(stage) or "").."\n-----------------------------\n")
    
    data = data.Body:sub(rdir[2]) --chop off <head>
    local actualstuff = getcontents(data)
    
    return actualstuff
end
print(contentify(0,1))