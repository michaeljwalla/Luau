--i dont feel like commenting this, as it doesnt work properly (overlaps, miscounting, etc)
--works okay i GUESS but its not my best work, also its unfinished because i got bored
if game.CoreGui:FindFirstChild("PuffTracker") then game.CoreGui.PuffTracker:Destroy() _G.run:Disconnect() end
local plr = game.Players.LocalPlayer
local defaultbg = Color3.new(0.333333, 0.333333, 0.333333)
local ft = loadstring(game:HttpGet("https://pastebin.com/raw/vJGeNYjT"))() --get field functions (super ugly code so i moved it online)
function text(item, udim)
	if not udim or type(udim) ~= "userdata" then udim = UDim2.new(0,150,0,25) end
	if not item.ClassName:find("Text") then error("item is not a txt box") end
	item.BackgroundColor3 = defaultbg
	item.Size = udim
	item.Font = Enum.Font.SourceSans
	item.TextColor3 = Color3.new(1, 1, 1)
	item.TextScaled = true
	item.TextSize = 14
	item.TextWrapped = true
	return item
end

local loggable --put/update data in workspace folder
if writefile then loggable = true end
local logtable = {}
if isfile("pufflog.json") then logtable = game.HttpService:JSONDecode(readfile("pufflog.json")) end

local puffgui = Instance.new("ScreenGui", game.CoreGui)
puffgui.Name = "PuffTracker"

local mm = Instance.new("Frame", puffgui)
mm.Name = "Menu"
mm.Size = UDim2.new(0,150,0,125)
mm.Position = UDim2.new(1,0,0.5,0)
mm.BackgroundColor3 = defaultbg

local showhide = text(Instance.new("TextButton", mm), UDim2.new(0,25,0,25))
showhide.Text = "<<"
showhide.Name = "toggle"
showhide.Position = UDim2.new(0,-26,0,0)
showhide.MouseButton1Down:Connect(function()
	local pos
	if mm.Position.X.Offset == -150 then showhide.Text = "<<" pos = 0 else do showhide.Text = ">>" pos = -150 end end
	mm.Position = UDim2.new(1,pos,0.5,0)
end)

local cpuffs = {["Common"] = 0, ["Rare"] = 0, ["Epic"] = 0, ["Legendary"] = 0, ["Mythic"] = 0}
local types = {}
local commons = text(Instance.new("TextButton", mm))
commons.Position = UDim2.new(0,0,0,(#mm:GetChildren()-2)*25)
commons.Name = "Common"
commons.Text = string.format("Common (%d)", cpuffs.Common)
commons.TextColor3 = BrickColor.new("Nougat").Color
types.Common = commons --im lazy
local rares = text(Instance.new("TextButton", mm))
rares.Position = UDim2.new(0,0,0,(#mm:GetChildren()-2)*25)
rares.Name = "Rare"
rares.Text = string.format("Rare (%d)", cpuffs.Rare)
rares.TextColor3 = BrickColor.new("Silver").Color
types.Rare = rares
local epics = text(Instance.new("TextButton", mm))
epics.Position = UDim2.new(0,0,0,(#mm:GetChildren()-2)*25)
epics.Name = "Epic"
epics.Text = string.format("Epic (%d)", cpuffs.Epic)
epics.TextColor3 = BrickColor.new("Bright yellow").Color
types.Epic = epics
local legs = text(Instance.new("TextButton", mm))
legs.Position = UDim2.new(0,0,0,(#mm:GetChildren()-2)*25)
legs.Name = "Legendary"
legs.Text = string.format("Legendary (%d)", cpuffs.Legendary)
legs.TextColor3 = BrickColor.new("Pastel Blue").Color
types.Legendary = legs
local mythics = text(Instance.new("TextButton", mm))
mythics.Position = UDim2.new(0,0,0,(#mm:GetChildren()-2)*25)
mythics.Name = "Mythic"
mythics.Text = string.format("Mythic (%d)", cpuffs.Mythic)
mythics.TextColor3 = BrickColor.new("Alder").Color
types.Mythic = mythics

function delf(inst)
	if inst.Parent then inst:Destroy() end--if item in game
end
--used for drag bars (will not work properly for all items because inst.PARENT.Position is updated
function draggable(inst)
	function mousePos()
		local mouse = game.Players.LocalPlayer:GetMouse()
		return {x = mouse.X, y = mouse.Y}
	end
	local mouse = game.Players.LocalPlayer:GetMouse()
	local start, curPos
	local movewithme
	inst.InputBegan:Connect(function(InputObject)
        if InputObject.UserInputType == Enum.UserInputType.MouseButton1 then
            movewithme = mouse.Button1Down:Connect(function()
	            start = mousePos()
	            while task.wait() and movewithme.Connected do
	            	curPos = mousePos()
	            	if curPos.x ~= start.x or curPos.y ~= start.y then
	            		inst.Parent.Position += UDim2.new(0,curPos.x - start.x,0, curPos.y - start.y)
	            		start = mousePos()
	            	end
	            end
	        end)
        end
    end)
    local mouseConnection
	mouseConnection = mouse.Button1Up:Connect(function()
		if inst == nil then mouseConnection:Disconnect() else do
			start = mousePos()
			curPos = start
			pcall(function()movewithme:Disconnect()end)
		end end
	end)
	
end

local baseframe = Instance.new("Frame")
baseframe.Size = UDim2.new(0,200,0,150)
baseframe.BackgroundColor3 = defaultbg
baseframe.ClipsDescendants = true
local close = text(Instance.new("TextButton", baseframe), UDim2.new(0,20,0,20))
close.Text = "X"
close.Position = UDim2.new(1,-20,0,0)
close.Name = "close"
local dragbar = text(Instance.new("TextLabel", baseframe))
dragbar.Size = UDim2.new(1,-20,0,20)
dragbar.BackgroundColor3 = defaultbg
dragbar.TextXAlignment = "Left"
dragbar.Name = "top"
local scroll = Instance.new("ScrollingFrame", baseframe)
scroll.Name = "scroll"
scroll.Size = UDim2.new(1,0,1,-20)
scroll.BackgroundColor3 = defaultbg
scroll.Position = UDim2.new(0,0,0,20)
scroll.CanvasSize = UDim2.new(1,-20,1,-20)
scroll.ScrollBarThickness = 2
local orderer = Instance.new("UIListLayout", scroll)
function updatecanvas(inst)
	if not inst then return warn("no instance chosen") end
	inst.CanvasSize = UDim2.new(1,-20,0,(-25)+(#inst:GetChildren()*25))
end

local popups = Instance.new("Frame", puffgui)
popups.Name = "Popups"
function _G.massupdate() end
commons.MouseButton1Down:Connect(function()
	if popups:FindFirstChild("Common") then popups.Common:Destroy() return end
	local newmenu = baseframe:Clone()
	newmenu.Name = "Common"
	newmenu.Parent = popups
	newmenu.top.Text = "    "..commons.Text
	newmenu.top.TextColor3 = commons.TextColor3
	newmenu.Position = UDim2.new(0,100,0,100)
	newmenu.close.MouseButton1Down:Connect(function() delf(newmenu) end)
	newmenu.scroll.ChildAdded:Connect(function() updatecanvas(newmenu.scroll) end)
	draggable(newmenu.top)
	_G.massupdate()
end)
rares.MouseButton1Down:Connect(function()
	if popups:FindFirstChild("Rare") then popups.Rare:Destroy() return end
	local newmenu = baseframe:Clone()
	newmenu.Name = "Rare"
	newmenu.Parent = popups
	newmenu.top.Text = "    "..rares.Text
	newmenu.top.TextColor3 = rares.TextColor3
	newmenu.Position = UDim2.new(0,350,0,100)
	newmenu.close.MouseButton1Down:Connect(function() delf(newmenu) end)
	newmenu.scroll.ChildAdded:Connect(function() updatecanvas(newmenu.scroll) end)
	draggable(newmenu.top)
	_G.massupdate()
end)
epics.MouseButton1Down:Connect(function()
	if popups:FindFirstChild("Epic") then popups.Epic:Destroy() return end
	local newmenu = baseframe:Clone()
	newmenu.Name = "Epic"
	newmenu.Parent = popups
	newmenu.top.Text = "    "..epics.Text
	newmenu.top.TextColor3 = epics.TextColor3
	newmenu.Position = UDim2.new(0,600,0,100)
	newmenu.close.MouseButton1Down:Connect(function() delf(newmenu) end)
	newmenu.scroll.ChildAdded:Connect(function() updatecanvas(newmenu.scroll) end)
	draggable(newmenu.top)
	_G.massupdate()
end)
legs.MouseButton1Down:Connect(function()
	if popups:FindFirstChild("Legendary") then popups.Legendary:Destroy() return end
	local newmenu = baseframe:Clone()
	newmenu.Name = "Legendary"
	newmenu.Parent = popups
	newmenu.top.Text = "    "..legs.Text
	newmenu.top.TextColor3 = legs.TextColor3
	newmenu.Position = UDim2.new(0,850,0,100)
	newmenu.close.MouseButton1Down:Connect(function() delf(newmenu) end)
	newmenu.scroll.ChildAdded:Connect(function() updatecanvas(newmenu.scroll) end)
	draggable(newmenu.top)
	_G.massupdate()
end)
mythics.MouseButton1Down:Connect(function()
	if popups:FindFirstChild("Mythic") then popups.Mythic:Destroy() return end
	local newmenu = baseframe:Clone()
	newmenu.Name = "Mythic"
	newmenu.Parent = popups
	newmenu.top.Text = "    "..mythics.Text
	newmenu.top.TextColor3 = mythics.TextColor3
	newmenu.Position = UDim2.new(0,1100,0,100)
	newmenu.close.MouseButton1Down:Connect(function() delf(newmenu) end)
	newmenu.scroll.ChildAdded:Connect(function() updatecanvas(newmenu.scroll) end)
	draggable(newmenu.top)
	_G.massupdate()
end)

function updatetext(inst, name) 
	inst.Text = string.format("%s (%d)", name,cpuffs[name])
end
function _G.massupdate()
	cpuffs = {Common = 0, Rare = 0, Epic = 0, Legendary = 0, Mythic = 0}
	for i, child in pairs(game.Workspace.Happenings.Puffshrooms:GetChildren()) do
		local rarity = string.gsub(child.Name, "PuffballMushroomModel", "")
		cpuffs[rarity] += 1 
	    updatetext(types[rarity], rarity)
		if popups:FindFirstChild(rarity) then
			updatetext(popups[rarity].top, rarity)
			update(child, rarity)
		end
	end
end

function update(pinst, rarity) --puff instance
	if pinst.Parent.Name ~= "Puffshrooms" then return end
	local function redoit()
		local stop = false
		for i,v in pairs(pinst:GetDescendants()) do
			if v.Name == "Gui" and v.Parent.Name == "Attachment" then stop = true break end
		end
		if not stop then wait() redoit() end
	end
	redoit()
	local gui = pinst["Puffball Top"].Attachment.Gui
	local level = string.gsub(gui.NameRow.TextLabel.Text, "[Puffhsroom ()Lvl]", "") --black magic
	local time
	local timeui
	local function redoit()
		for i,v in pairs(gui:GetDescendants()) do
			if v:IsA("TextLabel") and v.Text:find(":") then time = v.Text timeui = v break end
		end
		if not time then wait() redoit() end
	end
	redoit()
	local icon, field = ft.geticon(ft.isin(pinst["Puffball Stem"])) --field not used btw
	local btn = text(Instance.new("TextButton", popups[rarity].scroll), UDim2.new(0,175,0,25))
	btn.Name = level
	btn.Text = string.format("Level %d, %s", level, time)
	pinst.Changed:Connect(function() if pinst.Parent == nil and btn ~= nil then btn:Destroy() end end)
	btn.MouseButton1Down:Connect(function()
		if pinst.Parent ~= nil then plr.Character.HumanoidRootPart.CFrame = pinst["Puffball Stem"].CFrame end
	end)
	timeui.Changed:Connect(function(what)
		if what == "Text" then
			btn.Text = string.format("Level %d, %s", level, timeui.Text)
		end
	end)
	local img = Instance.new("ImageLabel", btn)
	img.Size = UDim2.new(0,25,0,25)
	img.Position = UDim2.new(1,0,0,0)
	img.BackgroundColor3 = defaultbg
	img.Image = icon
end

function log()
	writefile("pufflog.json", game.HttpService:JSONEncode(logtable))
end
--_G is global (access things here from other scripts)
_G.run = nil
_G.run = game.Workspace.Happenings.Puffshrooms.ChildAdded:Connect(function(child)
	local rarity = string.gsub(child.Name, "PuffballMushroomModel", "")
	cpuffs[rarity] += 1 
	if loggable then logtable[rarity] += 1 log() end
    updatetext(types[rarity], rarity)
	if popups ~= nil and popups:FindFirstChild(rarity) then
		updatetext(popups[rarity].top, rarity)
		update(child, rarity)
	end
	child.Changed:Connect(function()
		if child.Parent == nil then 
			cpuffs[rarity] -= 1
			if popups:FindFirstChild(rarity) then
				updatetext(popups[rarity].top, rarity)
			end
			updatetext(types[rarity], rarity) 
		end
	end)
end)
for i,v in pairs(game.Workspace.Happenings.Puffshrooms:GetChildren()) do --make sure preloaded puffs update
	v.Changed:Connect(function()
		local rarity = string.gsub(v.Name, "PuffballMushroomModel", "")
		if v.Parent == nil then 
			cpuffs[rarity] -= 1
			if popups:FindFirstChild(rarity) then
				updatetext(popups[rarity].top, rarity)
			end
			updatetext(types[rarity], rarity) 
		end
	end)
end

_G.massupdate() --update all guis/tables (does not log) (i do not remember why i made this _G)

for i,v in pairs(cpuffs) do --log preloaded puffs
	if not logtable[i] then logtable[i] = 0 end
	logtable[i] += v
	log()
end
