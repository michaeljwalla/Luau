--really unfortunate, 800 line script got overwritten by my dumbass
-- :(

--old version of my polar farm, do not use unless you want to CRASH.....
if shared.webhook then for i,v in pairs(shared.webhook) do v:Disconnect() end end
shared.webhook = {}
if game.CoreGui:FindFirstChild("countdown") then game.CoreGui.countdown:Destroy() end
--[[
    how to run quest functions
    1. require quest module
    2. call function with params:
        - self (or :)
        - quest name (can use IDToName)
        - player stats
    3. thats it (DONT FORGET)
]]
local lp = game.Players.LocalPlayer
local character = lp.Character
local monsters ={}
for i,v in pairs(game:GetService("Workspace").MonsterSpawners:GetChildren()) do
    monsters[v.MonsterType.Value] = monsters[v.MonsterType.Value] or {}
    table.insert(monsters[v.MonsterType.Value], {
        Position = (v.MonsterType.Value == "Werewolf" and Vector3.new(-188.875,70.00000762939453,-144.375)) or (v.Territory.Value.Name == "MushroomZone" and v.Territory.Value.Part.Position) or v.Territory.Value.Position,
        OnCooldown = function()
            return v:FindFirstChildWhichIsA('Attachment').TimerGui.TimerLabel.Visible, v:FindFirstChildWhichIsA('Attachment').TimerGui.TimerLabel.Text:match("%d+:%d%d$")
        end
    })
end

--[[gotopoint(monsters.Spider[1].Position)
if true then return end]]

local quests = require(game:GetService("ReplicatedStorage").Quests)
local polar = {}
for i,v in pairs(quests.GetAllQuests()) do if v.NPC == "Polar Bear" and v.Repeatable then polar[v.Name] = v end end --able to look for item without searching whole table
local stats = require(game.ReplicatedStorage.ClientStatCache)
local http = game:GetService("HttpService")
for i = 1,6 do
    game:GetService("ReplicatedStorage").Events.ClaimHive:FireServer(i)
end
function json(tbl) return http:JSONEncode(tbl) end
function unjson(str) return http:JSONDecode(str) end
local ticktable = {
    webhook = tick()-5,
    --newquest = tick()-7
    refstats = tick()
}
local cachedstats = stats:Get()

function getpp()
    return cachedstats.Modifiers.MaxBeeEnergy._.Mods[1].Combo
end

local aqname, aqtable
function getactivequest()
    for i,v in pairs(cachedstats.Quests.Active) do
        if not polar[v.Name] then continue end
        return v.Name, quests:Progress(v.Name, cachedstats), polar[v.Name].Tasks
    end
    return false
end

function nexttask(unused, progress, tasks)
    for i,v in pairs(progress) do
        if v[1] ~= 1 then
            return {Get = tasks[i].Type, OfType = tasks[i].MonsterType or tasks[i].Zone, Amount = tasks[i].Amount, Index = i}
        end
    end
    return false
end



function iscompleted()
    --[[local quest = getactivequest()
    if not quest then return true end
    local prog = quests:Progress(quest, cachedstats)
    for i,v in pairs(prog) do
        if v[1] ~= 1 then return false end
    end
    return true]]
    return not nexttask(getactivequest())
end
--print(iscompleted())
--if true then return end
--print(iscompleted())
--for i,v in pairs(quests:Get('Polar Bear: High Protein Bug Bar').Tasks[1]) do print(i,v) end


function edit(message, ...)
    local g = syn.request{
        Url = "https://(omit)",
        Method = "PATCH",
        Body = json{content = message, embeds = {...}},
        Headers ={['Content-Type'] = "application/json"}
    }
    return g
end
local questqueued
function newquest()
    --ticktable.refstats = tick()
    game.ReplicatedStorage.Events.RetrievePlayerStats:InvokeServer()
    if not iscompleted() then return end
    wait()
    game.ReplicatedStorage.Events.CompleteQuestFromPool:FireServer("Polar Bear")
    wait()
    game.ReplicatedStorage.Events.GiveQuestFromPool:FireServer("Polar Bear")
    while not getactivequest() do wait() end
    queuenew = false
end
local status = "Awaiting instruction"
function updatewebhook(onshutdown)
    local name, progress = getactivequest()
    local descs = quests:Get(name).Tasks
    if not progress or not descs then edit('error at'..tostring(os.date())'! couldn\'t find active quest') return end
    local msg = ""
    local average = 0
    for i,v in pairs(progress) do
        msg..= string.format("%s - %s\n", descs[i].Description, (v[1] == 1 and "âœ…") or (tostring(v[2]).." / "..tostring(v[3])))
        average += v[1]
    end
    average = tostring((average/#progress)*100):match("^%d*.?%d").."%"
    edit(lp.Name.." at "..os.date(),
    {title = 'Current polar power: '..tostring(getpp()),
      description = "",
      color = (not onshutdown and 0x00ff00) or 0xff0000,
      fields = {
            {
              name = 'Current quest',
              value = name.." - "..average,
            },
            {
              name = '\nQuest items',
              value = msg
            },
            {
                name = "Status",
                value = status
            }
        }
    })
print(status)
end
function findclosestrare()
    if not character or (character and not (character:FindFirstChild("Humanoid") and character:FindFirstChild("HumanoidRootPart")))then return end 
    local closestrare = {Part = nil, Magnitude = math.huge}
    for i,v in pairs(game.Workspace.Collectibles:GetChildren()) do
        local mag = (character.HumanoidRootPart.Position - v.Position).Magnitude
        if v.Color == Color3.fromRGB(110, 244, 240) and math.round(v.Transparency*10)/10  ~= 0.7 and v.Orientation.Z == 0 and mag < 50 and mag < closestrare.Magnitude then
            closestrare.Part = v
            closestrare.Magnitude = mag
        end
    end
    if not closestrare.Part then return false end
    return closestrare
end

local menu = Instance.new("ScreenGui", game.CoreGui)
menu.Name = "countdown"
local webcountdown = Instance.new("TextLabel", menu)
webcountdown.Position = UDim2.new(0,100,1,-100)
webcountdown.Text = "countdown"
webcountdown.Size = UDim2.new(0,150,0,25)
webcountdown.BackgroundTransparency = 1
webcountdown.TextSize = 18
webcountdown.TextColor3 = Color3.new(1,1,1)
local questcountdown = webcountdown:Clone()
questcountdown.Parent = menu
questcountdown.Position -= UDim2.new(0,0,0,25)
questcountdown.Visible = false
local statscountdown = questcountdown:Clone()
statscountdown.Parent = menu
statscountdown.Position -= UDim2.new(0,0,0,0)
statscountdown.Visible = false

local ended
local queuenew

--[[local tickhook
tickhook = hookfunction(Instance.new("RemoteFunction").InvokeServer,function(event)
    if event == game.ReplicatedStorage.Events.RetrievePlayerStats then ticktable.refstats = tick() end
    return tickhook(event)
end)]]
local isdoingtask
local lastpos = character.HumanoidRootPart.Position
local ishealing = false
local isconverting = false

function gotopoint(pos)
    if character and character:FindFirstChild("HumanoidRootPart") then
        local ended
        local t = tick()
        local difference = (character.HumanoidRootPart.Position - pos).Magnitude/50
        spawn(function() while tick()-t < difference and task.wait() do character.HumanoidRootPart.Velocity = Vector3.new(0,0,0) end wait(2) if not (ishealing or isconverting) then game:GetService("ReplicatedStorage").Events.PlayerActivesCommand:FireServer({Name = "Sprinkler Builder"}) end end)
        game:GetService("TweenService"):Create(character.HumanoidRootPart, TweenInfo.new(difference), {CFrame = CFrame.new(pos)}):Play()
    end
end
function dotask(task, questname)
    if not task then isdoingtask = false return end
    if task.Get == "Collect Pollen" then
        while quests:Progress(questname, cachedstats)[task.Index][1] ~= 1 do 
            wait(1/3)
            if ishealing then status = string.format("Healing to 80hp (at %d)", character.Humanoid.Health) if character.Humanoid.Health > 80 then ishealing = false end  continue end
            if character.Humanoid.Health < 30 then
                ishealing = true
                lastpos = Vector3.new(-8, 78, 53)
                gotopos(lastpos)
                continue
            end
            character:FindFirstChildWhichIsA("Tool").ClickEvent:FireServer()
            if (lastpos - game.Workspace.FlowerZones[task.OfType].Position).Magnitude > 10 or (character.HumanoidRootPart.Position - game.Workspace.FlowerZones[task.OfType].Position).Magnitude > 10 then lastpos = game.Workspace.FlowerZones[task.OfType].Position gotopoint(game.Workspace.FlowerZones[task.OfType].Position) end
            status = string.format("Collecting pollen at %s", v.TypeOf)
        end
    else if task.Get == "Defeat Monsters" then
        while quests:Progress(questname, cachedstats)[task.Index][1] ~= 1 do
            wait(1/3)
            
            if ishealing then status = string.format("Healing to 80hp (at %d)", character.Humanoid.Health) if character.Humanoid.Health >= 80 then ishealing = false end if (character.HumanoidRootPart.Position - lastpos).Magnitude > 10 then gotopoint(lastpos) end continue end
            if character.Humanoid.Health < 30 then
                ishealing = true
                lastpos = Vector3.new(-8, 78, 53)
                gotopoint(lastpos)
                continue
            end
            local notoncd = false
            local times = ""
            for i,v in pairs(monsters[task.OfType]) do
                local cd, timer = v.OnCooldown()
                times..="\n"..timer
                if not cd and (lastpos - v.Position).Magnitude > 10 or (character.HumanoidRootPart.Position - v.Position).Magnitude > 10 then notoncd = true lastpos = v.Position gotopoint(v.Position) status = string.format("Killing a %s",task.OfType) break end
            end
            if not notoncd then status = string.format("Waiting for %s%s",task.OfType, times) end
        end
    end
    end
    isdoingtask = false
end
table.insert(shared.webhook,game.RunService.Stepped:Connect(function()
    character = lp.Character
    cachedstats = stats:Get()
    if character:FindFirstChild("Humanoid") then character.Humanoid.JumpPower = 80 character.Humanoid.WalkSpeed = 40 end
    webcountdown.Text = string.format("Updating webhook in %ss", tostring(10-(tick()-ticktable.webhook)):match("^%d*.?%d"))
    --questcountdown.Text = string.format("Checking completion in %ss", tostring(10-(tick()-ticktable.newquest)):match("^%d*.?%d"))
    --statscountdown.Text = string.format("Retrieving stats in %ss", tostring(10-(tick()-ticktable.refstats)):match("^%d*.?%d"))
    if tick() - ticktable.webhook > 10 and not ended then 
        ticktable.webhook = tick()
        updatewebhook() 
    end
    --print(not ended and not queuenew and iscompleted())
    if not ended and not queuenew and iscompleted() then
        queuenew = true
        newquest()
    end
    if not isdoingtask then isdoingtask = true local x,y,z = getactivequest() dotask(nexttask("hi",y,z),x) end
end))
table.insert(shared.webhook,game.Players.PlayerRemoving:Connect(function(plr)
    if plr == lp then ended = true updatewebhook(true) end
end))