local lp = game.Players.LocalPlayer
local activator = require(game:GetService("ReplicatedStorage").Activatables.Toys).ButtonEffect
local toys = workspace:WaitForChild"Toys"
local desync = Instance.new"BindableEvent"
local http = game:GetService"HttpService"
local uis = game:GetService"UserInputService"
local stats = require(game.ReplicatedStorage.ClientStatCache)
if _G.lastInterrupt then _G.lastInterrupt:Disconnect() end
local keyInterrupts = {
    Enum.KeyCode.W,
    Enum.KeyCode.A,
    Enum.KeyCode.S,
    Enum.KeyCode.D,
    Enum.KeyCode.Space
}
local lastInterrupt = tick()-5
_G.lastInterrupt = uis.InputBegan:Connect(function(data, txtbox)
    if txtbox or not (data.KeyCode ~= Enum.KeyCode.Unknown and table.find(keyInterrupts, data.KeyCode)) then return end
    lastInterrupt = tick()
end)

zerotheY = Vector3.new(1,0,1)
local function hasprop(inst, prop)
    return pcall(function() return inst[prop] end)
end
local function apply(inst, tbl)
    for prop,val in next, tbl do
        if prop == 'Parent' then continue end
        if hasprop(inst, prop) then inst[prop] = val end
    end
    if tbl.Parent then inst.Parent = tbl.Parent end
    return
end
function gethum(plr)
    return (plr or lp).Character and (plr or lp).Character:FindFirstChild"Humanoid"
end
function getroot(plr)
    local hum = gethum(plr)
    return hum.RootPart
end

function rethread(n)
    syn.set_thread_identity(n)
end
local function jump(power)
    local hum = gethum()
    if hum then
        local pre = hum.JumpPower
        hum.JumpPower = power or hum.JumpPower
        hum.Jump = true
        task.delay(0, function()
            hum.JumpPower = pre
        end)
        
    end
    return
end
local function activate(what)
    if not toys:FindFirstChild(what) then return -1 end
    rethread(2)
    activator(lp, toys[what])
    rethread(7)
    return 0
end
--activate("Red Cannon")


local pathvisualizer = workspace:FindFirstChild"$paths" or apply(Instance.new("Folder"), {Parent = workspace, Name = "$paths"})

local walkmodule = {}

function walkmodule:WalkTo(pos, ay, az)
    local hum = gethum()
    if not hum then return 1 end
    hum.WalkToPoint = (ay and az and Vector3.new(pos,ay,az)) or pos
    return 0
end
function walkmodule:WalkRel(pos, ay, az)
    local hum = gethum()
    if not hum then return 1 end
    hum.WalkToPoint = hum.RootPart.Position + (ay and az and Vector3.new(pos,ay,az)) or pos
    return 0
end
function walkmodule:Traverse(tbl, ignoreY, lenient)
    local hum = gethum()
    root = hum.RootPart
    if not (hum and root) then return end
    local startpos = 1
    if lenient then
        for i,pos in next, tbl do if (root.Position - pos).Magnitude < (root.Position - tbl[startpos]).Magnitude then startpos = i end end
    end
    if not startpos then return end
    for i = startpos, #tbl do
        local pos = tbl[i]
        walkmodule:WalkTo(pos)
        while ((root.Position - pos) * (ignoreY and zerotheY or 1)).Magnitude > 5 do task.wait() end
    end
end
local function vec3(x) return Vector3.new(unpack(x)) end
local alignments = {
     --end w two underscores to flag as 'under' something else
    ['0bee'] = {
        spawn = {-114.043, 5.277, 271.535},
        redcannonrampcorner = {-199.979, 4.475, 318.769},
        sunmushdand = {-113.167, 4.889, 176.920},
        bottom5beeramp = {-2.410, 4.580, 164.919},
        sunbottomfenceopening = {-214.636, 4.475, 257.526},
        sunmushfenceopening = {-161.754, 4.475, 162.289},
        dandbeebearfenceopening = {-39.479, 4.475, 256.596},
        beginnershopanthill = {14.618, 4.475, 315.059},
        right5beerampbluf = {40.124, 4.475, 99.497},
        bluehq__ = {241.756, 4.973, 95.677},
        bluehqbottomfloor__ = {300.345, 4.575, 98.932},
        bluehqtopfloor__ = {285.082, 58.304, 106.298},--clover hilly
        bottomcloverhill = {35.219, 4.475, 168.944},
        slingshotmidledge = {78.069, 19.230, 171.449},
        honeystormtoy = {233.382, 33.975, 187.463},
        --commando chick
        aligncommandocave = {49.079, 32.745, 447.586},
    },
    ant = {
        --ant hill
        antgate = {49.079, 32.745, 447.586},
        antmarketcenter = {49.079, 32.745, 447.586}
    },
    ['5bee'] = {
        --5 bee zone
        spider5gatecorner = {13.564, 20.475, 37.443},
        moonamulet = {37.013, 20.475, -26.725},
        bottom10ramp = {204.131, 20.475, -21.444},
        panda10rampmedian = {179.820, 20.475, 35.966},
        pandabehindnpc = {123.843, 35.475, 15.314},
        viciousbottom15ramp = {-118.093, 20.475, 47.174},
        topmotherbeartent = {-232.595, 34.781, 71.649},
    },
    ['10bee'] = {
        --10 bee zone
        ['10gate'] = {232.050, 68.475, -94.391},
        frontpineapplepatch = {257.291, 68.475, -160.642},
        leftsidestump = {422.459, 96.454, -231.866},
        dapperinterior = {516.007, 138.506, -343.289},
        dapperbackroof = {591.464, 178.603, -383.786},
        dapperfrontroof = {477.698, 178.603, -322.018},
        scibearhill = {296.527, 102.941, -11.317}
    },
    ['15bee'] = {
        --15 bee zone
        pumpcact = {-193.583, 68.475, -146.499},
        pumpcactpine = {-271.083, 68.475, -139.874},
        aceshop = {-348.407, 68.475, -89.070},
        blender = {-411.941, 69.317, -0.818},
        aceinterior = {-481.419, 69.864, -0.933},
        rosebottomramp = {-336.674, 20.425, 86.442},
        roseredhq__ = {-267.604, 20.425, 172.481},
        redhqbottomfloor__ = {-341.088, 20.686, 215.992},
        redhqmidfloor = {-345.870, 46.465, 276.750},
        redhqtopfloor = {-338.884, 68.494, 213.673},
        toppumpkinramp = {-116.118, 118.475, -234.404},
        polarcorner = {-79.793, 118.475, -80.692}
    },
    ['25bee30bee'] = {
        --25/30 bee zone
        ['25gate'] = {101.272, 176.475, -109.613},
        ticket30gate = {27.246, 176.475, -202.585},
        back30gate = {34.658, 196.265, -312.083},
        nectarpot = {160.461, 175.266, -286.644},
        rbcpass = {-67.668, 182.649, -304.394},
        jarring1 = {34.204, 229.294, -408.878},
        jarring2 = {34.168, 232.397, -496.227},
        bbm = {89.223, 310.861, -286.569},
        nightmm = {-16.015, 310.991, -284.476},
    },
    ['35bee'] = {
        --35 bee zone
        coconut35gate = {-328.520, 50.515, 385.727},
        spiritbear = {-358.579, 81.907, 452.350},
        petalshop__ = {-496.772, 52.390, 396.464},
        petalshopinterior__ = {-498.444, 52.045, 504.397},
        petalhiddenstarjelly__ = {-426.907, 17.635, 556.560},
        --pepperwindshrine = {-490.811, 123.677, 477.656},
        windshrinebottomright = {-450.269, 139.487, 380.508},
    },
    misc = {
        --misc
        starhalloutside = {75.051, 65.603, 268.545},
        starhallinside = {144.124, 65.721, 330.383}
        
    }
}

local options = {}
walkmodule.MapOptions = options
--example align data
--[[
    
    {
        Mode = 'Align',
        Desynced = false,
        SpecifiedAlignment = 'starhallinside',
        Fuzziness = 5
    }


]]
local lastaligns = {}
--[[
1 - no valid alignment nearby
0 - success
-1 - missing param data
-2 - player exit
-3 - alignment overwritten
]]
function options:Align(data, hum, root)
    if typeof(data) == 'Vector3' then
        return self:Align({
            Desynced = false,
            SpecifiedAlignment = data,
            Fuzziness = 5,
            NoFloat = false,
            Yield = nil
        }, gethum(), getroot())
    end
    if not (hum and root) then return -1 end
    if data.NoFloat then self:WaitForGround(data, hum, root) end
    if data.Desynced or data.Yield then data.Desynced = nil task.wait(data.Yield) data.Yield = nil desync:Fire(self.Align, self, data, hum, root) return 0
    elseif not data.SpecifiedAlignment then
        local closest, zone
        for zoneAt, positions in next, alignments do
            for at, pos in next, positions do
                pos = vec3(pos)
                local distnew, distold = (root.Position - pos*zerotheY).Magnitude,
                not zone or (root.Position - vec3(alignments[zone][closest])*zerotheY).Magnitude
                if (not closest or (distnew < distold)) and (pos.Y - root.Position.Y <= 10 and (not at:find"__" or pos.Y - root.Position.Y >= -30)) and (pos - root.Position).Magnitude <= 180 then
                    closest = at
                    zone = zoneAt
                end
            end
        end
        if closest then data.SpecifiedAlignment = closest  self:Align(data, hum, root) return 0 end
        return 1 --no valid alignment nearby
    end
    for i,v in pairs(lastaligns) do rawset(lastaligns, i, nil)  end
    local pos
    if typeof(data.SpecifiedAlignment) == 'string' then
        for i,v in next, alignments do for a,x in next, v do if a == data.SpecifiedAlignment then pos = x break end end if pos then break end end
        assert(pos, "invalid align: "..tostring(data.SpecifiedAlignment))
        pos = vec3(pos)
    elseif typeof(data.SpecifiedAlignment) == 'Vector3' then
        pos = data.SpecifiedAlignment
    end
    local preInterrupt, id = lastInterrupt, Instance.new("Part"):GetDebugId()
    lastaligns[id] = true
    while (preInterrupt == lastInterrupt) and task.wait() and lastaligns[id] and (root.Position - pos).Magnitude > data.Fuzziness do
        walkmodule:WalkTo(pos)
    end
    if preInterrupt ~= lastInterrupt then print("plr interrupted alignment") hum.WalkToPoint = root.Position return -2 elseif not lastaligns[id] then print("alignment overwritten") return -3 end
    return 0
end
function options:WaitForGround(data, hum, root)
    while gethum() == hum and (hum.FloorMaterial == Enum.Material.Air or root.Velocity.Y > 1e-2) do task.wait() end
    return 0
end
function options:Toy(data)
    return activate(tostring(data.Type))
end
function options:Jump(data)
    jump()
end
function options:Yield(data)
    task.wait(data.Time)
    return 0
end
function options:Loadstring(data, hum, root, tbl, i)
    local x = loadstring(data.String)
    setfenv(x, setmetatable({stats = stats, self = walkmodule, lp = lp, data = data, hum = hum, root = root, tbl = tbl, i = i}, {__index = getfenv()}))
    
    return x(self, data, hum, root, tbl, i)
end
function walkmodule:FollowMap(tbl)
    local hum = gethum()
    local root = hum and hum.RootPart
    if not (hum and root) then return end
    for i,data in next, tbl do
        if options[data.Mode](options, data, hum, root, tbl, i) ~= 0 then break end
    end
end
walkmodule.fenv = setmetatable({stats = stats, self = walkmodule, lp = lp}, {__index = getfenv()})
--walkmodule:Traverse({Vector3.new(0,0,0), Vector3.new(20,0,20), Vector3.new(0,0,40)}, true)
desync.Event:Connect(function(f, ...) 
    f(...)
    return
end)
local map = {
    --[[{
        Mode = 'Align',
        Desynced = false,
        SpecifiedAlignment = nil,
        Fuzziness = 5,
        NoFloat = true,
        Yield = 0
    },]]
}
walkmodule:FollowMap(map)
return walkmodule