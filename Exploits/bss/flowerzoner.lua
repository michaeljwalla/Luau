local function require(d, recache)
    shared.requirecache = shared.requirecache or {}
    if (typeof(d) ~= 'string') then return getfenv().require(d) end
    if d:find"^http" then return loadstring(game:HttpGet(d))()
    else
        if not recache and shared.requirecache[d] then return shared.requirecache[d] end
        local n, a = pcall(readfile, d..".lua") --loadfile lol
        assert(n, "No local module '"..d.."'")
        local chunk = loadstring(a)
        assert(chunk, "Error in local: "..d)
        shared.requirecache[d] = chunk()
        return shared.requirecache[d]
    end
end

local lp = game.Players.LocalPlayer
local nametools = require(game.ReplicatedStorage.FlowerZoneTools)
local fzones = workspace.FlowerZones
local flowers = workspace.Flowers
local abs = math.abs
local format = "FP%d-%d-%d"
local noY = Vector3.new(1,0,1)
local function iswithin(num, min, max, exclusive)
    return (not exclusive and num >= min and num <= max) or (exclusive and num > min and num < max)
end
local function gethum(plr)
    plr = plr or lp
    return plr.Character and plr.Character:FindFirstChildOfClass"Humanoid"
end
local function getroot(plr)
    local hum = gethum(plr)
    return hum and hum.RootPart
end
local module = setmetatable({
    Zones = {},
    Gates = {
        ['35zone'] = {
            { --shrine area to white 35 ledge
                Vector3.new(-563.965, 0, 314.458),
                Vector3.new(-297.396, 0, 645.199),
            },
            { --coco rock stub
                Vector3.new(-321.966, 0, 411.964),
                Vector3.new(-275.097, 0, 427.929)
            },
            { --coco and cave
                Vector3.new(-315.691, 0, 427.139),
                Vector3.new(-94.823, 0, 568.867)
            }
        },
        FromSpawn = {
            {--ticket shop and black bear
                Vector3.new(-288.236, 0, 288.869),
                Vector3.new(-198.351, 0, 421.950)
            },
            { --spawns and demon mask
                Vector3.new(-288.058, 0, 288.820),
                Vector3.new(152, 0, 372.949)
            },
            {--lb to dand
                Vector3.new(-242.333, 0, 263.926),
                Vector3.new(-108.846, 0, 295.874)
            },
            {--dand to demon
                Vector3.new(-108.669, 0, 260.425),
                Vector3.new(322.665, 0, 331.168)
            },
            {
                Vector3.new(-12.426, 0, 370.157),
                Vector3.new(114.860, 0, 416.124)
            }
        },
        ['0zone'] = {
            {--everything
                Vector3.new(-255.086, 0, 62.815),
                Vector3.new(612.797, 0, 260.328)
            },
            {--rest of blue hq
                Vector3.new(255.070, 0, 55.667),
                Vector3.new(350.555, 0, 155.216)
            }
        },
        ['5zone'] = {
            {
                Vector3.new(-266, 0, -63.688),
                Vector3.new(255.494, 0, 63.668)
            }
        },
        ['15zone'] = {
            --[[{ --diamond mask
                Vector3.new(-368.149, 0, -439.347),
                Vector3.new(-320.637, 0, -245.470)
            },]]
            {--rest of
                Vector3.new(-478.358, 0, -257.136),
                Vector3.new(-50.233, 0, -64.038)
            },
            { --near rose and such
                Vector3.new(-478.358, 0, -257.136),
                Vector3.new(-256.937, 20.425, 246.396)
            },
            {--hq
                Vector3.new(-523.948, 68.475, 73.043),
                Vector3.new(-290.071, 46.465, 305.899)
            },
            {--to 25 ramp
                Vector3.new(-50.409, 0, -90.640),
                Vector3.new(119.067, 0, -64.859)
            }
        },
        ['25zone'] = {
            {
                Vector3.new(-53.793, 0, -254.423),
                Vector3.new(126.233, 0, -90.254)
            }
        },
        ['10zone'] = {
            {
                Vector3.new(126.677, 125.475, -254.293),
                Vector3.new(530.656, 188.629, -64.598)
            },
            {
                Vector3.new(254.504, 68.475, -90.253),
                Vector3.new(329.503, 134.662, 36.248),
            },
            {
                Vector3.new(308.870, 101.178, -509.763),
                Vector3.new(678.085, 153.163, -213.615)
            }
        },
        ['20zone'] = {
            {
                Vector3.new(-15.880, 0, 417.177),
                Vector3.new(207.489, 0, 682.178)
            }
        },
        ['30zone'] = {
            {
                Vector3.new(-156.208, 274.805, -599.497),
                Vector3.new(201.037, 338.263, -245)
            }
        }
    }
}, {__index = nametools})

--
local delay, yield, resume = task.delay, coroutine.yield, coroutine.resume
local thread = coroutine.running()
local function balance() delay(0, resume, thread) yield() end
warn('caching flowers')
local zones = module.GetZonesByIDs()
for id, _ in next, zones do
    local zone = {}
    module.Zones[id] = zone
    for i = 0, 50 do
        if not flowers:FindFirstChild(format:format(id, i, 12)) then continue --stump screws up everything
        elseif i % 2 == 0 then balance() end
        zone[i] = {}
        for a = 0, 50 do
            if not flowers:FindFirstChild(format:format(id, 12, a)) then continue end
            zone[i][a] = flowers:FindFirstChild(format:format(id, i, a))
        end
    end
    warn(id.." / "..#zones)
end
warn('done')
--

function module:GetCurrentGate(pos)
    for name, gate in next, module.Gates do
        for a, region in next, gate do
            if iswithin(pos.X, region[1].X, region[2].X) and iswithin(pos.Z, region[1].Z, region[2].Z) then return name end
        end
    end
    return nil
end
function module:IsInField(field, pos)
    field = typeof(field) == 'string' and self.ZoneNameToID(field) or field
    if field == 16 then return (pos - fzones['Stump Field'].Position).Magnitude <= 65 end
    field = self.Zones[field]
    local minpos, maxpos = field[0][0].Position - Vector3.new(2,0,2), field[#field][#field[#field]].Position + Vector3.new(2,0,2)
    return iswithin(pos.X, minpos.X, maxpos.X) and iswithin(pos.Z, minpos.Z, maxpos.Z)
end
function module:GetCurrentField(pos)
    for i,v in next, self.GetZonesByIDs() do
        if self:IsInField(i, pos) then return self.GetName(i) end
    end
    return nil
end
function module:GetCurrentFieldID(pos)
    for i,v in next, self.GetZonesByIDs() do
        if self:IsInField(i, pos) then return i end
    end
    return nil
end
function module:GetGateFromField(f)
    f = typeof(f) == 'number' and self.GetName(f) or f
    assert(fzones:FindFirstChild(f), "Invalid field.")
    return self:GetCurrentGate(fzones[f].Position)
end
module.GetID = module.ZoneNameToID
module.GetName = module.ZoneIDToName
function module:GetCurrentFlower(pos)
    local field = self:GetCurrentField(pos)
    local a, id  = pcall(self.GetID, field)
    if not a then return end
    local closest
    for z = 0, #self.Zones[id] do
        local z = self.Zones[id][z]
        if not z then continue end
        for x = 0, #z do
            local flower = z[x]
            if flower and (not closest or ((pos - flower.Position)*Vector3.new(1,0,1)).Magnitude < ((pos - closest.Position)*Vector3.new(1,0,1)).Magnitude) then
                closest = flower
            end
        end
    end
    return closest
end
return module