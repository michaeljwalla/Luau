local lp = game.Players.LocalPlayer
local data = shared.sdata.Data

local timergui = lp:WaitForChild("PlayerGui", 15) and lp.PlayerGui:WaitForChild("TimerGui", 15) or error(notify{Title = "Fatal Error", Text = "Missing component: TimerGui"} or "Fatal error. Script aborted.")
local tframe = timergui:WaitForChild"TimerFrame"

local function notify(options) --Title, Text, Duration, Icon
    game.StarterGui:SetCore("SendNotification", options)
end

local fontmodule = require(game.ReplicatedStorage:WaitForChild"Modules":WaitForChild"Font")

local tscript = timergui:WaitForChild("LocalScript (TimerGui)", 15)
local timerenv = getsenv(tscript)
local forceupd = timerenv.update

local upvalerr, colortable = pcall(getupvalue, fontmodule.generateText, 3)
if not (upvalerr and colortable and colortable.cyan) then--assert not working w functions lol?
    notify{Title = "Fatal Error", Text = "Missing font module colortable"}
    error"Fatal Error. Script aborted"
end
setmetatable(colortable, {
    __index = function(self, index)
        local t = typeof(index)
        return (t == 'Color3' and index) or (t == 'string' and BrickColor.new(index).Color) 
    end
})
-- now i can set the notice
local fentry = {
    Original = nil,  --no entry
    TextForce = "",
    ColorForce = "cyan",
    noticescript = tscript,
    upvaluelol = checkcaller,
    tshadow = tframe:WaitForChild"Shadow",
    tnotice = tframe:WaitForChild"Notice",
    Datapath = data
}
local oldfont
local hookfont = function(self, frame, text, color, whichfont, waittime, soundid, param8, param9, param10)
    
    if fentry.Datapath.sd2.Unloaded then
        return oldfont(self, frame, text, color, whichfont, waittime, soundid, param8, param9, param10)
    end
    local forcetext, forcecolor = fentry.TextForce, fentry.ColorForce
    if fentry.upvaluelol() and (not self or typeof(self) == 'string') then
        if not self or (forcetext == self) then return forcetext, forcecolor end
        fentry.TextForce = self and self:upper() or forcetext
        fentry.ColorForce = frame and (typeof(frame) == 'string' and frame:lower()) or frame or forcecolor -- setnotice(text, color) from syn
        --tick.Volume = 0
        forceupd() --cause of typeof==string
        --tick:Stop()
        --tick.Volume = 0.5 --i kind of like the extra ticking actually, sounds kinda cool
        return fentry.TextForce, fentry.ColorForce
    elseif (frame == fentry.tshadow or frame == fentry.tnotice) and forcetext ~= "" then
        return oldfont(self, frame, forcetext, frame == fentry.tshadow and "black" or forcecolor, whichfont, waittime, soundid, param8, param9, param10)
    else
        return oldfont(self, frame, text, color, whichfont, waittime, soundid, param8, param9, param10)
    end
end


oldfont = hookfunction(fontmodule.generateText, hookfont)

fentry.Original = oldfont
fentry.Call = fontmodule.generateText




--bring down timer whenever i want
local timerentry = {
    Original = nil,
    ForcedDown = false,
    Datapath = data
}
local oldtimer

local hidetimerval = game.ReplicatedStorage:WaitForChild"Info":WaitForChild"HideTimer"

local timersenv = getsenv(timergui:WaitForChild("LocalScript (TimerGui)", 15))
do 
    local t = tick()
    while tick() - t < 15 do

        for i,v in next, getconnections(hidetimerval.Changed) do
            if v.Function then
                local success, const = pcall(getconstant, v.Function, 2)
                if success and const == 'tweened' then
                    oldtimer = v.Function
                    --v:Disable()
                    break --found
                end
            end
        end
        if oldtimer then break end
        task.wait(0.5)
    end
end

if not oldtimer then--assert not working w functions lol?
    notify{Title = "Fatal Error", Text = "Missing timer toggle function"}
    shared.sdata.Queued = false
    error"Fatal Error. Script aborted"
end

timersenv.tweened = false
tframe.Visible = true
local nothing = function() end
local tupd = timersenv.update
local last, ot
local checkcaller = checkcaller
local hookhidetimer = function()
    if not fentry.Datapath.sd2.Unloaded then
        tweened = false
        if timerentry.ForcedDown then
            return
        end
        spawn = checkcaller() and nothing or fillExpBar --disable xp fillbar popup 
    end
    tupd()
    ot()
end

ot = hookfunction(oldtimer, hookhidetimer)
setfenv(hookhidetimer, timersenv)
timerentry.Call = oldtimer
timerentry.Original = ot
timerentry._env = timersenv
timerentry._signal = hidetimerval.Changed

return timerentry
