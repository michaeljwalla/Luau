local HTTPS = game:GetService("HttpService")
local TPS = game:GetService("TeleportService")


--local queue = syn.queue_on_teleport or queue_on_teleport
local ctr = 0
local function tp(ignorelist)
    local nextCursor, serverId;
    local maximum, current = 18, 0;
    while task.wait(1) do
	    repeat
	        local Servers;
	        if not nextCursor then
	            Servers = HTTPS:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Asc&limit=100"))
	        else
	            Servers = HTTPS:JSONDecode(game:HttpGet("https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Asc&limit=100&cursor="..nextCursor))
	        end
	        if (Servers) then
	            nextCursor = Servers.nextPageCursor or nil
	            for _,v in pairs(Servers.data) do
	                v.playing = v.playing or 0
	                if v.id == game.JobId then
	                    current = v.playing
	                elseif v.playing ~= 18 and v.playing < maximum --[[and v.playing < current and]]and not ignorelist[minimum] then
	                    maximum = v.playing
	                    serverId = v.id
	                end
	            end
	        end
	        task.wait()
	    until not nextCursor
	    if serverId then break else print(ctr) end
	    ctr = ctr + 1
	end
    print(serverId)
    if (serverId) then
        print("Teleporting to "..tostring(minimum).." Player Server!")
        TPS.TeleportInitFailed:Connect(function()
           printconsole("Failed... retrying")
           ignorelist[minimum] = true
           tp(ignorelist) 
        end)
        TPS:TeleportToPlaceInstance(game.PlaceId, serverId)
        
        return true
    else
        return false
    end
end
tp{}