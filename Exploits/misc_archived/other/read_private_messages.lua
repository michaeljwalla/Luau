if _G.chatsniped then for i,v in pairs(_G.chatsniped) do v:Disconnect() end end
_G.chatsniped = {}
local color = "Alder"
local chatpath = game.Players.LocalPlayer.PlayerGui.Chat.Frame.ChatChannelParentFrame.Frame_MessageLogDisplay.Scroller
function rss(text) --remove starting spaces
    if typeof(text) ~= "string" then return end
    while text:sub(1,1) == " " do
        text = text:sub(2,#text)
    end
    return text
end
function refresh()
    local systemmsg = {}
    local chatmsg = {}
    for i,v in pairs(chatpath:GetChildren()) do
        if not v:IsA("Frame") then continue end
        if v:FindFirstChild("TextLabel") and v.TextLabel:FindFirstChild("TextButton") then
            local str = string.gsub(v.TextLabel.TextButton.Text..v.TextLabel.Text, " ", "")
            table.insert(chatmsg, {Text = str, Object = v})
        else if v:FindFirstChild("TextLabel") and v.TextLabel.TextColor == BrickColor.new("Really red") then
            local str = string.gsub(v.TextLabel.Text, " ", "")
            table.insert(systemmsg, {Text = str, Object = v})
        end
        end
    end
    for i,v in pairs(systemmsg) do
        for a,x in pairs(chatmsg) do
            if x.Text:find(unmagic(v.Text)) then v.Object.Parent = nil end
        end
    end
end
function highestlayout()
    local curhigh = 0
    local frame = Instance.new("Frame")
    for i,v in pairs(chatpath:GetChildren()) do
        if v:IsA("Frame") and v.LayoutOrder > curhigh then frame = v curhigh = v.LayoutOrder end
    end
    return curhigh, frame
end
function unmagic(str)
	local original = str
	local look = "[().%%?[^$-]"
	--str = string.gsub(str, "-", "- ")
	local tbl = {}
	for i = 1, #str do
		table.insert(tbl, str:sub(i,i))
	end
	for i,v in pairs(tbl) do
		if v:find(look) then
			--dumb percent making me do more work
			if i == 1 or tbl[i] == "%" or tbl[i-1] ~= "%%" or (tbl[i-1] == "%%" and tbl[i-2] == "%%") then
				tbl[i] = "%"..v
			end
			
		end
	end
	str = ""
	for i,v in pairs(tbl) do
		str = str..v
	end
	return str, original
end
function findmessage(msg, player) --player optional
    for i,v in pairs(chatpath:GetChildren()) do
    	if v.Name == "Snipe" then continue end
        if (v:FindFirstChild("TextLabel") and tostring(v.TextLabel.Text):find(msg)) and (v.TextLabel:FindFirstChild("TextButton") and v.TextLabel.TextButton.Text:find(player.DisplayName)) then
            return v
        end
    end
    return false
end
function latestmessage(player)
	local highestlayout = Instance.new("Frame")
	local atleastone
	for i,v in pairs(chatpath:GetChildren()) do
		if v:IsA("Frame") and v.TextLabel:FindFirstChild("TextButton") and v.TextLabel.TextButton.Text:find(player.DisplayName) then
			if v.LayoutOrder > highestlayout.LayoutOrder then highestlayout = v atleastone = true end
		end
	end
	return atleastone and highestlayout
end
function isloading(player)
	local latest = latestmessage(player)
	if latest and (string.gsub(rss(latest.TextLabel.Text), "_", "") == "" or string.gsub(rss(latest.TextLabel.Text), " ", "") == "") then
		return true
	end
	return false
end
function newsnipe(msg, player, syscolor)
	game.StarterGui:SetCore( "ChatMakeSystemMessage",  { Text = string.format("[%s]: %s", player.DisplayName, msg), Color = BrickColor.new(syscolor or color or "Really red").Color})
end
function snipe(player)
	if player == game.Players.LocalPlayer then return end
    local connection
    connection = player.Chatted:Connect(function(msg)
    	msg, original = unmagic(msg)
    	local t = tick()
        spawn(function()
            local con
            local notused, frame = highestlayout()
            local text = frame:FindFirstChild("TextLabel") or frame.ChildAdded:Wait()
            local last = text.Text
            local t = tick()
            refresh()
            while wait(1) and (tick()-t < 5) and highestlayout() == frame do
                if last ~= text.Text then last = text.Text refresh() end
            end
        end)
    	while isloading(player) do 
    		wait()
    		if tick() - t > 15 then return end
		end
    	local shown = findmessage(msg, player)
    	if not shown and not (msg:find("/w "..game.Players.LocalPlayer.Name) == 1) then
    		newsnipe(original, player)
    	end
    end)
    table.insert(_G.chatsniped, connection)
end
wait(1)
for i,v in pairs(game.Players:GetPlayers()) do
	snipe(v)
end
table.insert(_G.chatsniped, game.Players.PlayerAdded:Connect(function(v)
	newsnipe(string.format("%s (%s) has joined the game.", v.DisplayName, v.Name), {DisplayName = "Server"}, "Deep orange")
	snipe(v)
end))
table.insert(_G.chatsniped, chatpath.ChildAdded:Connect(refresh))
table.insert(_G.chatsniped, game.Players.PlayerRemoving:Connect(function(v)
	newsnipe(string.format("%s (%s) has left the game.", v.DisplayName, v.Name), {DisplayName = "Server"}, "Baby blue")
end))
newsnipe("Sniping hidden messages",{DisplayName = "Your hot mom"}, "Alder")