local lp = game.Players.LocalPlayer
local speed = 10
while not lp.Character do wait() end
local hrp, hum = lp.Character:WaitForChild('HumanoidRootPart'),  lp.Character:WaitForChild('Humanoid')
local function getmass(char)
	local mass = 0
	for i,v in pairs(char:GetDescendants()) do
		if v:IsA"BasePart" then mass += v.Mass end
	end
	return mass
end

local t = task.wait()

local uis = game:GetService"UserInputService"

local function returnToZero(part, mass, t)
    hrp:ApplyImpulse(
    
Vector3.new(
    
math.abs(hrp.Velocity.X) > 0.01 and -hrp.Velocity.X or 0,
    
math.abs(hrp.Velocity.Y) > 0.01 and -hrp.Velocity.Y or 0,
    
math.abs(hrp.Velocity.Z) > 0.01 and -hrp.Velocity.Z or 0)
    

* mass * t * 15)

end
local function vecFloor(vector, mul)
    return Vector3.new(mul * math.floor(vector.X),math.floor(vector.Y),math.floor(vector.Z))
end
local function pushTo(part, pos, mass, time)
    local displace = (pos - part.Position).Unit
    part:ApplyImpulse(displace * t * mass * 15 * workspace.Gravity)
    
end
if _G.run99 then _G.run99:Disconnect() end
local flying = false
local lastSpacePressed = tick() - 19999
if _G.run27 then _G.run27:Disconnect() end
_G.run27 = uis.InputBegan:Connect(function(keycode, chat)
    if chat or keycode.KeyCode ~= Enum.KeyCode.Space or uis:IsKeyDown(Enum.KeyCode.RightControl) then return end
    if tick() - lastSpacePressed <  0.2 then
        flying = not flying
        if not flying then pcall(function() lp.Character.HumanoidRootPart.CFrame = CFrame.new(lp.Character.HumanoidRootPart.Position) end) end
    end
    lastSpacePressed = tick()
end)
local cc = workspace.CurrentCamera
local lastpos
local mouse = lp:GetMouse()
_G.run99 = game.RunService.Heartbeat:Connect(function(t)
	if not (lp.Character and lp.Character:FindFirstChild"Humanoid" and lp.Character:FindFirstChild"HumanoidRootPart") then return end
	hrp, hum = lp.Character.HumanoidRootPart, lp.Character.Humanoid
	if not flying then
	    hum.PlatformStand = false
	    for i,v in pairs(lp.Character:GetChildren()) do if v:IsA"BasePart" then v.CanCollide = true  end end
	    return
	end
    local mass = getmass(lp.Character)
    local speedconstant = mass*speed
    local gravity = Vector3.new(0,196.2) * t * mass
    hrp:ApplyImpulse(gravity)
    if uis:IsKeyDown(Enum.KeyCode.LeftControl) then
        hrp:ApplyImpulse(-gravity/2 * speed)
    elseif not uis:IsKeyDown(Enum.KeyCode.RightControl) and uis:IsKeyDown(Enum.KeyCode.Space) and math.abs(hrp.Velocity.Y) <= 50 then
        hrp:ApplyImpulse(gravity * speed)
    end
    
    local lrvec = Vector3.zero
    if ((hrp.Velocity.X < 50 and hum.MoveDirection.X > 0) or (hrp.Velocity.X > -50 and hum.MoveDirection.X < 0)) then
        lrvec += Vector3.new(hum.MoveDirection.X) * 5
    end
    if ((hrp.Velocity.Z < 50 and hum.MoveDirection.Z > 0) or (hrp.Velocity.Z > -50 and hum.MoveDirection.Z < 0)) then
        lrvec += Vector3.new(0,0,hum.MoveDirection.Z) * 5
    end
    
    if lrvec.Magnitude > 0 then
        hrp:ApplyImpulse(lrvec*speedconstant)
        --lastpos = hrp.Position + (hrp.Velocity * t) + 1/2 * (lrvec * 15 * speedconstant) * t^2
    end
    
    if lastpos then pushTo(hrp, vecFloor(lastpos, 5), mass, t) end
    returnToZero(part, mass, t)
    hrp.CFrame = CFrame.new(hrp.CFrame.Position) * cc.CFrame.Rotation
end)
if _G.run199 then _G.run199:Disconnect() end
_G.run199 = game.RunService.Stepped:Connect(function()
    if not flying then return end
    hum.PlatformStand = true
    for i,v in pairs(lp.Character:GetChildren()) do if v:IsA"BasePart" then v.CanCollide = false  end end
    
end)