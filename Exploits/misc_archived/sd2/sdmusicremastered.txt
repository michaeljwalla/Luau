--my longest-line projects, BOTH times i wrote this (i remade it)
local customonly = false
local presetoff = false
if game.CoreGui:FindFirstChild("sdmp") then game.CoreGui.sdmp:Destroy() end
if not _G.assets then _G.assets = {} end
local getcustomasset = getcustomasset or getsynasset
if not writefile or not getcustomasset then 
	game.StarterGui:SetCore("SendNotification", {
		Title = "Warning";
		Text = "Get a better executor rofl";
		Duration = 5;
	})
	return
end
function json(item)
	if typeof(item) ~= "table" then return end
	local str = game:GetService("HttpService"):JSONEncode(item)
	str = string.gsub(str, "null,","")
	str = string.gsub(str,"null","")
	return str
end
function unjson(item)
	return pcall(function() game:GetService("HttpService"):JSONDecode(item) end) and game:GetService("HttpService"):JSONDecode(item)
end

local usr = game:GetService("UserInputService")
local mouse = game.Players.LocalPlayer:GetMouse()
local songs = {}
local templist = {}
local favorites
if (isfile("sd2f.json") and not pcall(function() unjson(readfile("sd2f.json")) end)) or not isfile("sd2f.json") then 
	writefile("sd2f.json", json({}))
	favorites = {} 
else if isfile("sd2f.json") then
	favorites = unjson(readfile("sd2f.json"))
end
end
--[[for imports]] if not isfolder("sd2c") then makefolder("sd2c") end
local imports
if (isfile("sd2i.json") and not pcall(function() unjson(readfile("sd2i.json")) end)) or not isfile("sd2i.json") then 
	writefile("sd2i.json", json({}))
	imports = {}
else if isfile("sd2i.json") then
	imports = unjson(readfile("sd2i.json"))
end
end
local presets
if (isfile("sd2p.json") and not pcall(function() unjson(readfile("sd2p.json")) end)) or not isfile("sd2p.json") then 
	writefile("sd2p.json", json({}))
	presets = {}
else if isfile("sd2i.json") then
	presets = unjson(readfile("sd2p.json"))
end
end

local index = 1
local playing = 0
local volume = 0.5
local maxvol = 10 --caps at 10
local music = game.ReplicatedStorage.Music
local maps = game.ReplicatedStorage.Maps
local shuffled = false
local previewasset = {} --i think unused, too lazy to check
local removeconfirm = 0

local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "sdmp"
local main = Instance.new("Frame", gui)
main.Name = "Main"
main.Size = UDim2.new(1,0,1,0)
main.BackgroundTransparency = 1
local playtoggle = Instance.new("TextButton", main)
playtoggle.Name = "Switcher"
playtoggle.BackgroundColor3 = Color3.new(0.333333, 0.333333, 0.333333)
playtoggle.Position = UDim2.new(1,-300,1,-25)
playtoggle.Size = UDim2.new(0, 200, 0, 25)
playtoggle.Font = Enum.Font.SourceSans
playtoggle.TextColor3 = Color3.new(1, 1, 1)
playtoggle.TextScaled = true
playtoggle.TextSize = 10
playtoggle.TextWrapped = true
playtoggle.Text = "Hello, world!"
local currentbox = Instance.new("TextLabel", main)
currentbox.Name = "Current"
currentbox.BackgroundColor3 = Color3.new(0.333333, 0.333333, 0.333333)
currentbox.Position = UDim2.new(1,-375,1,-50)
currentbox.Size = UDim2.new(0, 350, 0, 25)
currentbox.Font = Enum.Font.SourceSans
currentbox.TextColor3 = Color3.new(1, 1, 1)
currentbox.TextScaled = true
currentbox.TextSize = 10
currentbox.TextWrapped = true
currentbox.Text = ""
currentbox.BackgroundTransparency = 1
local storage = Instance.new("Folder", gui) --has to have a parent to load sound
storage.Name = "Songs"
local leftbutton = playtoggle:Clone()
leftbutton.Parent = main
leftbutton.Name = "Left"
leftbutton.Size = UDim2.new(0,25,0,25)
leftbutton.Position -= UDim2.new(0,25,0,0)
leftbutton.Text = "<"
local rightbutton = leftbutton:Clone()
rightbutton.Parent = main
rightbutton.Name = "Right"
rightbutton.Position += UDim2.new(0,225,0,0)
rightbutton.Text = ">"
local menu = Instance.new("Frame", gui)
menu.Name = "Menu"
menu.Size = UDim2.new(0,150,0,250)
menu.Position = UDim2.new(0.5,0,0.5,0)
menu.BackgroundColor3 = Color3.new(1/4,1/4,1/4)
menu.Position = UDim2.new(1,0,1,-300)
local open = Instance.new("TextButton", menu)
open.Size = UDim2.new(0,25,0,25)
open.Position = UDim2.new(0,-26,0,0)
open.Font = Enum.Font.SourceSans
open.BackgroundColor3 = Color3.new(0.333333, 0.333333, 0.333333)
open.TextColor3 = Color3.new(1, 1, 1)
open.TextScaled = true
open.TextSize = 10
open.TextWrapped = true
open.Text = "<<"
local volumecontrols = Instance.new("Frame",  menu)
volumecontrols.Name = "Volume"
volumecontrols.Size = UDim2.new(0,35,0,40)
volumecontrols.Position = UDim2.new(0,0,1,-40)
volumecontrols.BackgroundColor3 = Color3.new(0.333333, 0.333333, 0.333333)
local volbar = volumecontrols:Clone()
volbar.Parent = volumecontrols
volbar.Size = UDim2.new(0,13,0,40)
local fillbar = volbar:Clone()
fillbar.Parent = volbar
fillbar.BackgroundColor3 = Color3.new(0,1,0)
fillbar.BorderSizePixel = 0
fillbar.Size = UDim2.new(0,13,volume/maxvol,0)
fillbar.Position = UDim2.new(0,0,1-volume/maxvol,0)
local volup = Instance.new("TextButton", volumecontrols)
volup.Size = UDim2.new(0,21,0.5,0)
volup.Position = UDim2.new(0,14,0,0)
volup.Name = "Up"
volup.Text = "/\\"
volup.TextXAlignment = "Center"
volup.TextYAlignment = "Top"
volup.Font = Enum.Font.SourceSans
volup.BackgroundColor3 = Color3.new(0.333333, 0.333333, 0.333333)
volup.TextColor3 = Color3.new(1, 1, 1)
volup.TextSize = 18
volup.TextWrapped = true
local voldown = volup:Clone()
voldown.Parent = volumecontrols
voldown.Name = "Down"
voldown.Text = "\\/"
voldown.Position = UDim2.new(0,14,0.5,0)
local popups = Instance.new("Frame", gui)
popups.Name = "Popups"
popups.Size = UDim2.new(1,0,1,0)
popups.BackgroundTransparency = 1

--useful \/
local popup = Instance.new("Frame")
--useful /\
popup.Size = UDim2.new(0,180,0,240)
popup.BackgroundColor3 = Color3.new(1/3,1/3,1/3)
popup.Position = UDim2.new(0,150,0,150)
local backpanel = Instance.new("TextButton", popup)
backpanel.Size = UDim2.new(1,0,1,0)
local close = Instance.new("TextButton", popup)
close.Name = "X"
close.Size = UDim2.new(0,20,0,20)
close.Position = UDim2.new(1,-20,0,-20)
close.Font = Enum.Font.SourceSans
close.BackgroundColor3 = Color3.new(0.333333, 0.333333, 0.333333)
close.TextColor3 = Color3.new(1, 1, 1)
close.TextScaled = true
close.TextSize = 10
close.TextWrapped = true
close.Text = "X"
local dragbar = Instance.new("TextLabel", popup)
dragbar.Size = UDim2.new(1,-20,0,20)
dragbar.BackgroundColor3 = Color3.new(1/3,1/3,1/3)
dragbar.Name = "Drag"
dragbar.Position = UDim2.new(0,0,0,-20)
dragbar.Font = Enum.Font.SourceSans
dragbar.TextColor3 = Color3.new(1, 1, 1)
dragbar.TextScaled = true
dragbar.TextSize = 10
dragbar.TextWrapped = true
dragbar.Text = ""
dragbar.TextXAlignment = "Left"
local searchtab = playtoggle:Clone()
searchtab.Parent = menu
searchtab.Name = "Search"
searchtab.Text = "Search"
searchtab.Size = UDim2.new(1,0,0,25)
searchtab.Position = UDim2.new(0,0,0,0)
local searchpopup = popup:Clone()
searchpopup.Parent = popups
searchpopup.Name = "Search"
searchpopup.Drag.Text = "	Search"
searchpopup.Visible = false
local searchinput = Instance.new("TextBox", searchpopup)
searchinput.Size = UDim2.new(1,0,0,20)
searchinput.BackgroundColor3 = Color3.new(1/3,1/3,1/3)
searchinput.Font = Enum.Font.SourceSans
searchinput.TextColor3 = Color3.new(1, 1, 1)
searchinput.TextScaled = true
searchinput.TextSize = 10
searchinput.TextWrapped = true
searchinput.PlaceholderText = "..."
searchinput.Text = ""
local searchtotal = dragbar:Clone()
searchtotal.Parent = searchpopup
searchtotal.TextXAlignment = "Center"
searchtotal.Position = UDim2.new(0,0,1,-20)
searchtotal.Size = UDim2.new(1,0,0,20)
searchtotal.Text = "-"
local searchresults = Instance.new("ScrollingFrame", searchpopup)
searchresults.Size = UDim2.new(1,0,1,-40)
searchresults.Position = UDim2.new(0,0,0,20)
searchresults.ScrollBarThickness = 2
searchresults.BackgroundColor3 = Color3.new(1/3,1/3,1/3)
searchresults.CanvasSize = UDim2.new(1,-20,1,-40)
local favstab = searchtab:Clone()
favstab.Parent = menu
favstab.Name = "Favorites"
favstab.Text = "Favorites"
favstab.Position = UDim2.new(0,0,0,25)
local favspopup = popup:Clone()
favspopup.Parent = popups
favspopup.Name = "Favorites"
favspopup.Drag.Text = string.format("	Favorites (%d)", #favorites)
favspopup.Visible = false
local favsholder = searchresults:Clone()
favsholder.Parent = favspopup
favsholder.Position = UDim2.new(0,0,0,0)
local favsort = Instance.new("UIListLayout", favsholder)
favsort.SortOrder = "Name"
local addfav = Instance.new("TextButton", favspopup)
addfav.TextXAlignment = "Center"
addfav.BackgroundColor3 = Color3.new(1/3,1/3,1/3)
addfav.Position = UDim2.new(0,0,1,-40)
addfav.Size = UDim2.new(1,0,0,20)
addfav.Font = Enum.Font.SourceSans
addfav.TextColor3 = Color3.new(1, 1, 1)
addfav.TextScaled = true
addfav.TextSize = 10
addfav.TextWrapped = true
addfav.Text = "Add Song"
local remfav = addfav:Clone()
remfav.Parent = favspopup
remfav.Position = UDim2.new(0,0,1,-20)
remfav.Text = "Remove Song"
local customtab = favstab:Clone()
customtab.Parent = menu
customtab.Name = "Custom"
customtab.Text = "Custom"
customtab.Position = UDim2.new(0,0,0,50)
local custompopup = popup:Clone()
custompopup.Parent = popups
custompopup.Name = "Custom"
custompopup.Drag.Text =  string.format("	Custom (%d)", 0)
custompopup.Visible = false
local customholder = searchresults:Clone()
customholder.Parent = custompopup
customholder.Size -= UDim2.new(0,0,0,20)
customholder.Position = UDim2.new(0,0,0,0)
local addcustom = addfav:Clone()
addcustom.Parent = custompopup
addcustom.Position = UDim2.new(0,0,1,-60)
addcustom.Text = "Add Song"
local remcustom = addfav:Clone()
remcustom.Parent = custompopup
remcustom.Position = UDim2.new(0,0,1,-40)
remcustom.Text = "Remove Song"
local helpcustom = addfav:Clone()
helpcustom.Parent = custompopup
helpcustom.Position = UDim2.new(0.5,0,1,-20)
helpcustom.Text = "Help"
helpcustom.Size = UDim2.new(0.5,0,0,20)
local refreshcustom = helpcustom:Clone()
refreshcustom.Parent = custompopup
refreshcustom.Position = UDim2.new(0,0,1,-20)
refreshcustom.Text = "Reload"
local cpp = popup:Clone() --custom preview popup
cpp.Parent = popups
cpp.Name = "Custom (Preview)"
cpp.Drag.Text =  "Custom (Preview)"
cpp.Size = UDim2.new(0,180,0,20)
cpp.Visible = false
local cpinput = searchinput:Clone() --ok bad abbreviation
cpinput.Parent = cpp
cpinput.PlaceholderText = "Enter Audio Id"
local cppbackground = Instance.new("Frame", cpp)
cppbackground.BackgroundColor3 = Color3.new(0.333333, 0.333333, 0.333333)
cppbackground.Size = UDim2.new(1,0,1,-20)
cppbackground.Position = UDim2.new(0,0,0,20)
local cpprb = cppbackground:Clone()--cpp real background
cpprb.Parent = cpp
cpprb.Visible = false
local cppconfirm = playtoggle:Clone()
cppconfirm.Parent = cpprb
cppconfirm.Size = UDim2.new(1,0,0,20)
cppconfirm.Position = UDim2.new(0,0,1,-20)
cppconfirm.Text = "Confirm"
cppconfirm.Name = "Confirm"
local cppname = cpinput:Clone()
cppname.Name = "Name"
cppname.Parent = cpprb
cppname.PlaceholderText = "Name"
cppname.Position = UDim2.new(0,0,1,-40)
local cpptoggle = cppconfirm:Clone()
cpptoggle.Name = "Toggle"
cpptoggle.Parent = cpprb
cpptoggle.Size = UDim2.new(1/2,0,0,20)
cpptoggle.Position = UDim2.new(1/4,0,1,-61)
cpptoggle.Text = "00:00 / 00:00"
local cppseek = cpptoggle:Clone()
cppseek.Name = "Seek"
cppseek.Parent = cpprb
cppseek.Size = UDim2.new(1/4,0,0,20)
cppseek.Position = UDim2.new(3/4,0,1,-61)
cppseek.Text = ">>"
local cpprewind = cppseek:Clone()
cpprewind.Name = "Rewind"
cpprewind.Parent = cpprb
cpprewind.Position = UDim2.new(0,0,1,-61)
cpprewind.Text = "<<"
local cpptimepos = volbar:Clone()
cpptimepos.Parent = cpprb
cpptimepos.Position = UDim2.new(0,0,1,-82)
cpptimepos.Size = UDim2.new(1,0,0,20)
cpptimepos.Volume.Size = UDim2.new(0.5,0,1,0)
cpptimepos.Volume.Position = UDim2.new(0,0,0,0)
local cpplaceholder = Instance.new("Sound", cpp)
cpplaceholder.Name = "Preview"
local advtab = customtab:Clone()
advtab.Parent = menu
advtab.Name = "Advanced"
advtab.Text = "Advanced"
advtab.Position = UDim2.new(0,0,0,75)
local advpopup = popup:Clone()
advpopup.Parent = popups
advpopup.Name = "Advanced"
advpopup.Drag.Text = "Advanced"
advpopup.Visible = false
advpopup.Size = UDim2.new(0,180,0,50)
local advcontrol = cpprb:Clone()
advcontrol.Parent = advpopup
advcontrol.Visible = true
advcontrol.Confirm:Destroy()
advcontrol:FindFirstChild("Name"):Destroy()
advcontrol.Position += UDim2.new(0,0,0,50)
advcontrol.BackgroundTransparency = 1
local advname = advpopup.Drag:Clone()
advname.Parent = advpopup
advname.Position = UDim2.new(0,0,0,0)
advname.Size = UDim2.new(1,0,0,20)
advname.Text = ""
advname.TextXAlignment = "Center"
local presettab = advtab:Clone()
presettab.Parent = menu
presettab.Name = "Map Presets"
presettab.Text = "Map Presets"
presettab.Position = UDim2.new(0,0,0,125)
local presetpopup = popup:Clone()
presetpopup.Parent = popups
presetpopup.Name = "Map Presets"
presetpopup.Drag.Text = "Map Presets"
presetpopup.Visible = false
local presetmaps = searchresults:Clone()
presetmaps.Parent = presetpopup
presetmaps.Size = UDim2.new(1,0,1,-80)
presetmaps.Position = UDim2.new(0,0,0,0)
presetmaps.CanvasSize = UDim2.new(1,-20,1,-80)
local presetorder = Instance.new("UIListLayout", presetmaps)
local presetchosen = searchtotal:Clone()
presetchosen.Parent = presetpopup
presetchosen.Position = UDim2.new(0,0,1,-80)
local presetsong = cppconfirm:Clone()
presetsong.Parent = presetpopup
presetsong.Position = UDim2.new(0,0,1,-60)
presetsong.Text = "-"
local presetset = cppconfirm:Clone()
presetset.Parent = presetpopup
presetset.Position = UDim2.new(0,0,1,-40)
presetset.Text = "Set Preset"
local presetclear = presetset:Clone()
presetclear.Parent = presetpopup
presetclear.Position = UDim2.new(0,0,1,-20)
presetclear.Text = "Clear Preset"
local togglepresettab = presettab:Clone()
togglepresettab.Parent = menu
togglepresettab.Name = "PresetToggle"
togglepresettab.Text = string.format("Presets: %s", not presetoff and "On" or "Off")
togglepresettab.Position = UDim2.new(0,0,0,150)

for i,v in pairs(music:GetDescendants()) do
	if not gui.Parent or customonly then break end
	--task.spawn(function()
        local id
        if v.Name == "Loop" then id = string.format("rbxassetid://%d", v.Value) end
        if id and id ~= "rbxassetid://0" then
            local sound = Instance.new("Sound", storage)
            sound.Name = string.format("%s - %s", v.Parent.Parent.Name, v.Parent.Name)
            sound.SoundId = id
            sound.Looped = true
            playtoggle.Text = string.format("Loading: %s", sound.Name)
            local t = tick()
            while tick()-t < 0.1 and not sound.IsLoaded do task.wait() end
            if not sound.IsLoaded then sound:Destroy() end
            table.insert(songs, (sound.IsLoaded and {Name = sound.Name}) or nil)
        end
    --end)
end

if not gui.Parent then return end
function rift(item, tbl)
	for i,v in pairs(tbl) do
		if v.Name == item then table.remove(tbl, i) return end
	end
end
function forcestop()
	for i,v in pairs(storage:GetChildren()) do
		v:Stop()
	end
	playing = 0
	index = 1
end
function draggable(inst)
	local mouse = game.Players.LocalPlayer:GetMouse()
	function mousePos()
		return {x = mouse.X, y = mouse.Y}
	end
	local start, curPos
	local movewithme
	inst.InputBegan:Connect(function(InputObject)
        if InputObject.UserInputType == Enum.UserInputType.MouseButton1 then
            movewithme = mouse.Button1Down:Connect(function()
	            start = mousePos()
	            local run
	            run = game.RunService.RenderStepped:Connect(function()
	            	if not movewithme.Connected or not inst.Parent then run:Disconnect() return end
	            	curPos = mousePos()
	            	if curPos.x ~= start.x or curPos.y ~= start.y then
	            		inst.Parent.Position += UDim2.new(0,curPos.x - start.x,0, curPos.y - start.y)
	            		start = mousePos()
	            	end
	            end)
	        end)
        end
    end)
    local mouseConnection
	mouseConnection = mouse.Button1Up:Connect(function()
		if inst == nil then mouseConnection:Disconnect() else do
			start = mousePos()
			curPos = start
			pcall(function()movewithme:Disconnect()end)
		end end
	end)
end
print('copyrighted audios^')
function closeable(inst)
	inst.MouseButton1Down:Connect(function() inst.Parent.Visible = false end)
end
function formattime(time)
	if typeof(time) ~= "number" then return end
	local mm = (time - (time % 60)) / 60 --repeat of h but with remaining time and 60
    local ss = (time - (mm * 60))
	return string.format("%d:%s%d", mm,  ss < 10 and 0 or "", ss)
end

function getsound(name)
	if typeof(name) ~= "table" and typeof(name) ~= "string" then return false end
	name = (typeof(name) == "table" and name.Name) or name
	for i,v in pairs(storage:GetChildren()) do
		if string.lower(name) == string.lower(v.Name) then
			return v, i
		end
	end
	return false
end
function getasset(id) --if return.AssetTypeId == then isSound = true
	local valid = pcall(function() game:GetService("MarketplaceService"):GetProductInfo(id) end)
	return valid and game:GetService("MarketplaceService"):GetProductInfo(id) or false
end

function updatecurrent()
	local song, sindex = getsound(songs[playing])
	local indexed, iindex = getsound(songs[index])
	if not song then playing = 0 end
	if not indexed then index = 1 end
	if playing == index then 
		removeconfirm = 0
		remcustom.Text = "Remove Song"
	end
	if song then
		currentbox.Text = string.format("%s: %s\n[%d/%d]", (song.IsPlaying and "Playing") or "Paused", songs[playing].Name, playing, #songs)
		if songs[sindex] and songs[sindex].Local then currentbox.TextColor3 = Color3.fromRGB(171,209,255) else if  songs[sindex] and songs[sindex].Import then currentbox.TextColor3 = Color3.fromRGB(131,255,170) else do currentbox.TextColor3 = Color3.new(1,1,1) end end end
	end
	if indexed then
		playtoggle.Text = string.format("%s\n[%d/%d]", songs[index].Name, index, #songs)
		if songs[iindex] and songs[iindex].Local then playtoggle.TextColor3 = Color3.fromRGB(171,209,255) else if songs[iindex] and songs[iindex].Import then playtoggle.TextColor3 = Color3.fromRGB(131,255,170) else do playtoggle.TextColor3 = Color3.new(1,1,1) end end end
	end
	if playing == 0 then currentbox.Text = "" currentbox.TextColor3 = Color3.new(1,1,1) end
end

function updatefavs()
	writefile("sd2f.json", json(favorites))
	favspopup.Drag.Text = string.format("	Favorites (%d)", #favorites)
	local remoffset = 0
	for i,v in pairs(favsholder:GetChildren()) do if v:IsA("TextButton") then v:Destroy() end end
	for i,v in pairs(favorites) do
		local song, indx = getsound(v.Name)
		if song then
			local new = playtoggle:Clone()
			new.Parent = favsholder
			new.Name = v.Time
			new.Size = UDim2.new(1,0,0,25)
			new.Text = v.Name
			new.Position = UDim2.new(0,0,0,25*(#favsholder:GetChildren()-1))
			new.BackgroundColor3 = Color3.new(1/4,1/4,1/4)
			favsholder.CanvasSize = UDim2.new(1,-20,0,25*(#favsholder:GetChildren()-1))
			local sound, indx = getsound(v.Name)
			if songs[indx].Local then new.TextColor3 = Color3.fromRGB(171,209,255) else if songs[indx].Import then new.TextColor3 = Color3.fromRGB(131,255,170) else do new.TextColor3 = Color3.new(1,1,1) end end end
			new.MouseButton1Down:Connect(function()
				local song = getsound(songs[playing])
				if song then song:Stop() end
				song, indx = getsound(v.Name)
				playing = indx
				index = indx
				song.Volume = volume
				song:Play()
				updatecurrent()
				cpp.Preview:Pause()
			end)
		end
	end
end
function updatepresets()
	--presets = unjson(readfile("sd2p.json"))
	for i,v in pairs(presetmaps:GetChildren()) do if not v:IsA("UIListLayout") then v:Destroy() end end 
	local new = playtoggle:Clone()
	new.Size = UDim2.new(1,0,0,25)
	new.BackgroundColor3 = Color3.new(1/4,1/4,1/4)
	for i,v in pairs(maps:GetChildren()) do
		local map = new:Clone()
		map.Parent = presetmaps
		map.Position = UDim2.new(0,0,0,25*(#presetmaps:GetChildren()-2))
		map.Name = v.Name
		map.Text = v.Name
		map.TextColor3 = Color3.new(1,1,1)
		presetmaps.CanvasSize = UDim2.new(1,-20,0,25*(#presetmaps:GetChildren()-1))
		for a,x in pairs(presets) do
			if x.Map == v.Name then
				map.BackgroundColor3 = Color3.new(1/6,1/6,1/6)
			end
		end
		map.MouseButton1Down:Connect(function() --yea its the same function
			presetchosen.Text = map.Name
			for a,x in pairs(presets) do
				if x.Map == v.Name then
					presetsong.Text = x.Name
					presetsong.TextColor3 = ((x.Name:find("Local [-]") == 1) and  Color3.fromRGB(171,209,255) )or (x.Name:find("Import [-]") and Color3.fromRGB(131,255,170)) or Color3.new(1,1,1)
					map.BackgroundColor3 = Color3.new(1/6,1/6,1/6)
					break
				else do
					presetsong.Text = "-"
					presetsong.TextColor3 = Color3.new(1,1,1)
				end
				end
			end
		end)
	end
	writefile("sd2p.json", json(presets))
end
function refresh(added)
	local new = playtoggle:Clone()
	new.Size = UDim2.new(1,0,0,25)
	new.BackgroundColor3 = Color3.new(1/4,1/4,1/4)
	imports = unjson(readfile('sd2i.json'))
	local locals = listfiles('sd2c')
	for i,v in pairs(customholder:GetChildren()) do v:Destroy() end
	for i,v in pairs(storage:GetChildren()) do
		if v.Name:find("Local [-] ") == 1 or v.Name:find("Import [-] ") == 1 then v:Destroy() end
	end
	for i,v in pairs(locals) do
		if v:find(".ogg") == #v - 3 then
			local newsong = Instance.new("Sound", storage)
			newsong.Name = string.format("Local - %s", v:sub(6, #v - 4))
			if not _G.assets[v] then _G.assets[v] = getcustomasset(v) end
			newsong.SoundId = _G.assets[v]
			newsong.Volume = volume
			newsong.Looped = true
			local playbutton = new:Clone()
			playbutton.Parent = customholder
			playbutton.Text = newsong.Name
			playbutton.Position = UDim2.new(0,0,0,25*(#customholder:GetChildren()-1))
			playbutton.TextColor3 = Color3.fromRGB(171,209,255)
			playbutton.Name = newsong.Name
		end
	end
	for i,v in pairs(imports) do
		local newsong = Instance.new("Sound", storage)
		newsong.Name = string.format("Import - %s", v.Name)
		newsong.SoundId = v.Id
		newsong.Volume = volume
		newsong.Looped = true
		local t = tick()
		while not newsong.IsLoaded and tick()-t < 0.5 do wait() end
		if not newsong.Loaded then newsong:Destroy() return end
		local playbutton = new:Clone()
		playbutton.Parent = customholder
		playbutton.Text = newsong.Name
		playbutton.Position = UDim2.new(0,0,0,25*(#customholder:GetChildren()-1))
		playbutton.TextColor3 = Color3.fromRGB(131,255,170)
		playbutton.Name = newsong.Name
	end
	--always run last
	songs = {}
	for i,v in pairs(storage:GetChildren()) do
		if v.Name:find("Local [-] ") == 1 then
			table.insert(songs, {Name = v.Name, Local = true})
		else if v.Name:find("Import [-] ") == 1 then
			table.insert(songs, {Name = v.Name, Import = true})
		else do
			table.insert(songs, {Name = v.Name})
		end
		end
		end
	end
	for i,v in pairs(customholder:GetChildren()) do
		local associate, place = getsound(v.Text)
		v.MouseButton1Down:Connect(function()
			local current = getsound(songs[playing])
			if current then current:Stop() end
			associate:Play()
			associate.Volume = volume
			playing = place
			index = place
			cpp.Preview:Pause()
			updatecurrent()
		end)
	end
	if not added then forcestop() end --so dumb
	updatecurrent()
	customholder.CanvasSize = UDim2.new(1,-20,0,25*(#customholder:GetChildren()))
	custompopup.Drag.Text = string.format("	Custom (%d)", #customholder:GetChildren())
	if not added and loadpreset then loadpreset(game.Workspace.Map:FindFirstChildWhichIsA("Model")) end
end

open.MouseButton1Down:Connect(function()
	menu.Position = (menu.Position == UDim2.new(1,0,1,-300) and UDim2.new(1,-150,1,-300)) or UDim2.new(1,0,1,-300)
	open.Text = (menu.Position == UDim2.new(1,0,1,-300) and "<<") or ">>"
end)

playtoggle.MouseButton1Down:Connect(function()
	local song = getsound(songs[playing])
	if index == playing and song then
		if song.IsPaused then song:Resume() else do song:Pause() end end
	else if index ~= playing then
		if song then song:Stop() end
		local newsong = getsound(songs[index])
		if newsong then newsong.Volume = volume newsong:Play() end
		playing = index
	end
	end
	cpp.Preview:Pause()
	updatecurrent()
end)

leftbutton.MouseButton1Down:Connect(function()
	index = (index - 1 < 1 and #songs) or index - 1 --lazy if/elif
	updatecurrent()
end)
rightbutton.MouseButton1Down:Connect(function()
	index = (index + 1 > #songs and 1) or index + 1
	updatecurrent()
end)
volup.MouseButton1Down:Connect(function()
	volume = (volume + 0.1 > maxvol and maxvol) or (volume + 0.1)
	fillbar.Size = UDim2.new(0,13,volume/maxvol,0)
	fillbar.Position = UDim2.new(0,0,1-volume/maxvol,0)
	local song = getsound(songs[playing])
	if song then song.Volume = volume end
	cpp.Preview.Volume = volume
end)
voldown.MouseButton1Down:Connect(function()
	volume = (volume - 0.1 < 0 and 0) or (volume - 0.1)
	fillbar.Size = UDim2.new(0,13,volume/maxvol,0)
	fillbar.Position = UDim2.new(0,0,1-volume/maxvol,0)
	local song = getsound(songs[playing])
	if song then song.Volume = volume end
	cpp.Preview.Volume = volume
end)

searchtab.MouseButton1Down:Connect(function()
	searchpopup.Visible = true
	searchpopup.Position = UDim2.new(0,150,0,150)
end)
searchinput.FocusLost:Connect(function()
	local input = string.lower(searchinput.Text)
	for i,v in pairs(searchresults:GetChildren()) do v:Destroy() end
	local found = 0
	for i,v in pairs(storage:GetChildren()) do
		if string.lower(v.Name):find(input) then
			local new = playtoggle:Clone()
			new.Parent = searchresults
			new.Size = UDim2.new(1,0,0,25)
			new.Text = v.Name
			new.Position = UDim2.new(0,0,0,25*(#searchresults:GetChildren()-1))
			new.BackgroundColor3 = Color3.new(1/4,1/4,1/4)
			searchresults.CanvasSize = UDim2.new(1,-20,0,25*(#searchresults:GetChildren()))
			local sound, indx = getsound(v.Name)
			if songs[indx].Local then new.TextColor3 = Color3.fromRGB(171,209,255) else if songs[indx].Import then new.TextColor3 = Color3.fromRGB(131,255,170) else do new.TextColor3 = Color3.new(1,1,1) end end end
			new.MouseButton1Down:Connect(function()
				local song = getsound(songs[playing])
				if song then song:Stop() end
				song, indx = getsound(v.Name)
				playing = indx
				index = indx
				song.Volume = volume
				song:Play()
				updatecurrent()
				cpp.Preview:Pause()
			end)
			found += 1
		end
	end
	searchtotal.Text = string.format("%d Found", found)
end)

favstab.MouseButton1Down:Connect(function()
	favspopup.Visible = true
	favspopup.Position = UDim2.new(0,350,0,150)
end)
for i,v in pairs(favorites) do
	templist[v.Name] = v
end
favorites = {}
for i,v in pairs(templist) do
	table.insert(favorites,v)
end
templist = {}
addfav.MouseButton1Down:Connect(function()
	local name = getsound(songs[playing])
	if not name then return end
	for i,v in pairs(favorites) do
		if v.Name == name.Name then return end
	end
	table.insert(favorites, {Name = name.Name, Time = tick()})
	updatefavs()
end)
remfav.MouseButton1Down:Connect(function()
	local name = getsound(songs[playing])
	if not name then return end
	for i,v in pairs(favorites) do
		if v.Name == name.Name then
			table.remove(favorites, i)
			updatefavs()
			break
		end
	end
end)
customtab.MouseButton1Down:Connect(function()
	custompopup.Visible = true
	custompopup.Position = UDim2.new(0,550,0,150)
	removeconfirm = 0
	remcustom.Text = "Remove Song"
end)
local lasthelped = tick()-6
helpcustom.MouseButton1Down:Connect(function()
	if tick() - lasthelped < 6 then return end
	lasthelped = tick()
	game.StarterGui:SetCore("SendNotification", {
		Title = "Importing non-roblox audios";
		Text = "Place any .ogg files you want imported in /workspace/sd2c\nyou may need to convert it";
		Duration = 5;
	})
end)

refreshcustom.MouseButton1Down:Connect(function() refresh() end) --no weird return
remcustom.MouseButton1Down:Connect(function() --removes wrong audios (only thing not working i think)
	if songs[playing] and not songs[playing].Local and not songs[playing].Import then return end
	removeconfirm += 1
	if removeconfirm == 2 then
		local name = getsound(songs[playing])
		if not name then return end
		for i,v in pairs(favorites) do
			if v.Name == name.Name then
				table.remove(favorites, i)
				updatefavs()
				break
			end
		end
		if songs[playing].Local then
			local fname = name.Name:sub(9,#name.Name)
			local file = isfile('sd2c\\'..fname..'.ogg') and 'sd2c\\'..fname..'.ogg'
			if not file then return end
			writefile(file..".removed", readfile(file))
			delfile(file)
			name:Destroy()
			refresh(true)
		else if songs[playing].Import then
			for i,v in pairs(imports) do
				local song, indx = getsound("Import - "..v.Name)
				if song and tostring(song.SoundId) == tostring(v.Id) then
					song:Destroy()
					local offset = 1
					for x,a in pairs(imports) do
						if a.Name == v.Name then table.remove(imports,offset) break end
						offset += 1
					end
					writefile("sd2i.json", json(imports))
					refresh(true)
					break
				end
			end
		end
		end
		updatecurrent()
		removeconfirm = 0
		remcustom.Text = "Remove Song"
	else do
		remcustom.Text = "Confirm?"
		local t = tick()
		while tick()-t < 5 and removeconfirm == 1 do wait() end
		if removeconfirm == 1 then removeconfirm = 0 remcustom.Text = "Remove Song" end
	end
	end
end)
addcustom.MouseButton1Down:Connect(function()
	cpp.Visible = true
	cpp.Position = UDim2.new(0,550,0,450)
end)

cpinput.FocusLost:Connect(function()
	cpprb.Visible = false
	cpp.Size = UDim2.new(0,180,0,20)
	if cpinput == "" then return end
	previewasset = getasset(cpinput.Text)
	if not previewasset then cpinput.Text = "Not a valid asset" return
	else if previewasset.AssetTypeId ~= 3 then cpinput.Text = "Asset is not an audio" return 
	else if imports["rbxassetid://"..previewasset.AssetId] then cpinput.Text = "Already imported" return 
	end end end
	if cpp:FindFirstChild("Preview") then cpp.Preview:Destroy() end
	local previewsound = Instance.new("Sound", cpp)
	previewsound.Name = "Preview"
	previewsound.Looped = true
	previewsound.Volume = volume
	previewsound.SoundId = string.format("rbxassetid://%d", previewasset.AssetId)
	local t = tick()
	while tick()-t < 0.5 and not previewsound.IsLoaded do wait() end
	if not previewsound.IsLoaded then cpinput.Text = "Unable to download audio" return end
	cpp.Size = UDim2.new(0,180,0,100)
	cpprb.Visible = true
	cppname.Text = previewasset.Name
	cpptimepos.Volume.Size = UDim2.new(0,0,1,0)
	spawn(function()
		while wait() and cpp.Visible do
			cpptimepos.Volume.Size = UDim2.new(previewsound.TimePosition/previewsound.TimeLength,0,1,0)
			cpptoggle.Text = string.format("%s / %s", formattime(previewsound.TimePosition), formattime(previewsound.TimeLength))
		end
	end)
end)
cppname.FocusLost:Connect(function()
	if cppname.Text == "" then cppname.Text = previewasset.Name or "" end
end)
cpptoggle.MouseButton1Down:Connect(function()
	local song = getsound(songs[playing])
	if song then song:Pause() updatecurrent() end
	if not cpp.Preview.IsPlaying then cpp.Preview:Resume() else do cpp.Preview:Pause() end end
	updatecurrent()
end)
cppseek.MouseButton1Down:Connect(function()
	local previewsound = cpp.Preview
	previewsound.TimePosition =  previewsound.TimePosition + 5 > previewsound.TimeLength and previewsound.TimeLength or previewsound.TimePosition + 5
	cpptimepos.Volume.Size = UDim2.new(previewsound.TimePosition/previewsound.TimeLength,0,1,0)
	cpptoggle.Text = string.format("%s / %s", formattime(previewsound.TimePosition), formattime(previewsound.TimeLength))
end)
cpprewind.MouseButton1Down:Connect(function()
	local previewsound = cpp.Preview
	previewsound.TimePosition = previewsound.TimePosition - 5 < 0 and 0 or previewsound.TimePosition - 5
	cpptimepos.Volume.Size = UDim2.new(previewsound.TimePosition/previewsound.TimeLength,0,1,0)
	cpptoggle.Text = string.format("%s / %s", formattime(previewsound.TimePosition), formattime(previewsound.TimeLength))
end)
cppconfirm.MouseButton1Down:Connect(function()
	for i,v in pairs(storage:GetChildren()) do
		if v.SoundId == cpp.Preview.SoundId then return end
	end
	cpp.Visible = false
	cpprb.Visible = false
	cpp.Size = UDim2.new(0,180,0,20)
	cpp.Preview:Stop()
	table.insert(imports, {Id = cpp.Preview.SoundId, Name = cppname.Text})
	writefile("sd2i.json", json(imports))
	refresh(true)
	updatecurrent()
end)
advtab.MouseButton1Down:Connect(function()
	advpopup.Visible = true
	advpopup.Position = UDim2.new(0,150,0,450)
	while wait() and advpopup.Visible do
		if playing == 0 then
			advname.Text = "-"
			advcontrol.Volume.Volume.Size = UDim2.new(0,0,1,0)
			advcontrol.Toggle.Text = string.format("%s / %s", formattime(0), formattime(0))
		else do
			local sound = storage:FindFirstChild((songs[playing] and songs[playing].Name) or "")
			if sound then
				advname.Text = sound.Name
				if advname.Text:find("Local [-] ") == 1 then advname.TextColor3 = Color3.fromRGB(171,209,255) else if advname.Text:find("Import [-] ") == 1 then advname.TextColor3 = Color3.fromRGB(131,255,170) else do advname.TextColor3 = Color3.new(1,1,1) end end end
				advcontrol.Volume.Volume.Size = UDim2.new(sound.TimePosition/sound.TimeLength,0,1,0)
				advcontrol.Toggle.Text = string.format("%s / %s", formattime(sound.TimePosition), formattime(sound.TimeLength))
			end
		end
		end
	end
end)
advcontrol.Toggle.MouseButton1Down:Connect(function()
	local song = getsound(songs[playing])
	if song and not song.IsPlaying then song:Resume() else if song then song:Pause() end end
	cpp.Preview:Pause()
	updatecurrent()
end)
advcontrol.Seek.MouseButton1Down:Connect(function()
	local song = getsound(songs[playing])
	if not song then return end
	song.TimePosition =  (song.TimePosition + 5 > song.TimeLength and song.TimeLength) or song.TimePosition + 5
	advcontrol.Volume.Volume.Size = UDim2.new(song.TimePosition/song.TimeLength,0,1,0)
	advcontrol.Toggle.Text = string.format("%s / %s", formattime(song.TimePosition), formattime(song.TimeLength))
end)
advcontrol.Rewind.MouseButton1Down:Connect(function()
	local song = getsound(songs[playing])
	if not song then return end
	song.TimePosition =  song.TimePosition - 5 < 0 and 0 or song.TimePosition - 5
	advcontrol.Volume.Volume.Size = UDim2.new(song.TimePosition/song.TimeLength,0,1,0)
	advcontrol.Toggle.Text = string.format("%s / %s", formattime(song.TimePosition), formattime(song.TimeLength))
end)
presettab.MouseButton1Down:Connect(function()
	presetpopup.Visible = true
	presetpopup.Position = UDim2.new(0,750,0,150)
	local currentmap = game.Workspace.Map:FindFirstChildOfClass("Model")
	if currentmap then
		for i,v in pairs(presets) do
			if currentmap.Name == v.Map then
				presetchosen.Text = v.Map
				presetsong.Text = v.Name
				presetsong.TextColor3 = (v.Name:find("Local [-]") == 1 and Color3.fromRGB(171,209,255)) or (v.Name:find("Import [-]") and Color3.fromRGB(131,255,170)) or Color3.new(1,1,1)
			end
		end
	end
end)
presetset.MouseButton1Down:Connect(function()
	if not songs[playing] or not getsound(songs[playing]) then return end
	local song = getsound(songs[playing])
	local songfound
	for a,x in pairs(presets) do
		if x.Map == presetchosen.Text then
			presets[a] = nil
		end
	end
	table.insert(presets, {Map = presetchosen.Text, Name = song.Name})
	presetsong.Text = song.Name
	presetsong.TextColor3 = (song.Name:find("Local [-]") == 1 and Color3.fromRGB(171,209,255)) or (song.Name:find("Import [-]") and Color3.fromRGB(131,255,170)) or Color3.new(1,1,1)
	updatepresets()
end)
presetsong.MouseButton1Down:Connect(function()
	local song, place = getsound(presetsong.Text)
	if song then
		if getsound(songs[playing]) then getsound(songs[playing]):Stop() end
		cpp.Preview:Pause()
		song.Volume = volume
		song:Play()
		playing = place
		index = place
		updatecurrent()
	end
end)
presetclear.MouseButton1Down:Connect(function()
	for a,x in pairs(presets) do
		if x.Map == presetchosen.Text then
			presetsong.Text = "-"
			presetsong.TextColor3 = Color3.new(1,1,1)
			if songs[playing] == x.Name and getsound(x.Name) then getsound(x.Name):Stop() end
			presets[a] = nil
			updatepresets()
			break
		end
	end
end)
function loadpreset(map)
	if not typeof(map) == "Instance" then return end
	local place
	for a,x in pairs(presets) do
		if x.Map == map.Name then
			place = a
		end
	end
	--if song is already playing do nothing
	--if not then stop old song, play preset
	local cur, curplace = getsound(songs[playing])
	local play, place = getsound(presets[place] and presets[place].Name) --place isnt redefined until next line
	if cur ~= play or (cur == play and (cur and not cur.IsPlaying)) then
		if cur then cur:Stop() end
		playing = place
		index = place
		play.Volume = volume
		play:Play()
		updatecurrent()
	end
end
local preset
preset = game.Workspace.Map.ChildAdded:Connect(function(inst)
	if not gui.Parent then preset:Disconnect() end
	if not inst:IsA("Model") or shuffled or presetoff then return end
	loadpreset(inst)
end)
togglepresettab.MouseButton1Down:Connect(function()
	presetoff = not presetoff
	togglepresettab.Text = string.format("Presets: %s",  not presetoff and "On" or "Off")
	if not presetoff then loadpreset(game.Workspace.Map:FindFirstChildWhichIsA("Model")) end
end)
local hideall
hideall = usr.InputBegan:Connect(function(key,chat)
	if not gui.Parent then hideall:Disconnect() end
	if key.KeyCode ~= Enum.KeyCode.BackSlash or chat then return end
	for i,v in pairs(popups:GetChildren()) do
		v.Visible = false
	end
end)
wait(0.1)
draggable(searchpopup.Drag)
closeable(searchpopup.X)
draggable(favspopup.Drag)
closeable(favspopup.X)
draggable(custompopup.Drag)
closeable(custompopup.X)
draggable(cpp.Drag)
closeable(cpp.X)
draggable(advpopup.Drag)
closeable(advpopup.X)
draggable(presetpopup.Drag)
closeable(presetpopup.X)

refresh()
updatepresets()
updatefavs()
updatecurrent()