--snippets have been omitted for privacy.
local strict = true
if _G.messageScanner2 then _G.messageScanner2:Disconnect() end
local uids = {
	--removed for privacy
}

local url = 'removed for privacy'

local http = game.HttpService
local random = math.random
local request = syn and syn.request or http_request

local function post(url, body)
	return request{
		Url = url,
        Method = 'POST',
        Headers = {
            ['Content-Type'] = 'application/json'	
        },
        Body = game.HttpService:JSONEncode(body)
	}
end
statidentifier = {
    ['weekly blox'] = 'WeeklyEnemyExp', --why is weekly blox in xp and not coins?
    ['hc survs'] = 'TotalSurvivals2',
    ['weekly hc survs'] = 'WeeklySurvivals2',
    ['los'] = 'LastOneStanding',
    ['coins'] = 'Coins',
    ['weekly paci pb'] = 'WeeklyStreak3',
    ['hc paci pb'] = 'BestStreak4',
    ['weekly survs'] = 'WeeklySurvivals',
    ['total rounds'] = 'TotalRounds',
    ['weekly pb'] = 'WeeklyStreak',
    ['total survs'] = 'TotalSurvivals',
    ['hc pb'] = 'BestStreak2',
    ['weekly hc paci pb'] = 'BestStreak4',
    ['blox'] = 'TotalEnemyCoins', --double for xp
    ['pb'] = 'BestStreak',
    ['total xp'] = 'TotalExpEarned',
    ['paci pb'] = 'BestStreak3',
    ['gambles'] = 'Gachapon',
    ['weekly hc blox'] = 'WeeklyEnemyExp2', --why is weekly blox in xp and not coins?
    ['hc blox'] = 'TotalEnemyCoins2',
    ['weekly hc pb'] = 'WeeklyStreak2',
    ['pb hc sr'] = 'SkillRatingBest2',
    ['pb sr'] = 'SkillRatingBest',
    ['memos'] = 'MemosCollected',
    ['total coins'] = 'TotalCoinsEarned',
    ['sr'] = 'SkillRating',
    ['hc sr'] = 'SkillRating2'
}
local round = math.round
local abs = math.abs
local floor = math.floor
local function commas(num)
    local decimal = round(abs(num % 1) * 1e2)
    num = floor(num)
    local result = tostring(num):reverse():gsub("(%d%d%d)", "%1,"):reverse():gsub("^,", "")
    
    return decimal > 0 and result.."."..round(decimal) or result
end
local board = game.ReplicatedStorage:WaitForChild"Board"
local function getstat(type, plr, yield)
    plr = plr or lp --default to self

    local statsplr = board:FindFirstChild(tostring(plr))
    if not statsplr then return '?' end

    type = type:lower()

    local stat = statidentifier[type]
    if yield then
        stat = stat and statsplr:WaitForChild(stat, 15) and statsplr[stat].Value
    else
        stat = stat and statsplr:FindFirstChild(stat) and statsplr[stat].Value
    end
    if stat and not type:find'weekly' and type:find'blox' then return commas(stat*2) end
    return stat and commas(stat) or '?'
end
local function getusericon(uid)
	uid = uid or lp.UserId
	local x = http:JSONDecode(game:HttpGet(("https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=%d&size=48x48&format=Png&isCircular=false"):format(uid)))
	return x and x.data and x.data[1] and x.data[1].imageUrl
end
local lp = game.Players.LocalPlayer
local lbs = game.ReplicatedStorage:WaitForChild("Global", 5)
local gamemode = game.ReplicatedStorage:WaitForChild("Info", 5) and game.ReplicatedStorage.Info:WaitForChild("Gamemode", 5)
gamemode = gamemode and gamemode.Value

local lbs = game.ReplicatedStorage:WaitForChild("Global", 5)
local gamemode = game.ReplicatedStorage:WaitForChild("Info", 5) and game.ReplicatedStorage.Info:WaitForChild("Gamemode", 5)
gamemode = gamemode and gamemode.Value

local function numtoplace(num)
	num = abs(num)
	local f = commas(num)
	if num == 1 then
		return f.."st place"
	elseif num ==2 then
		return f.."nd place"
	elseif num == 3 then
		return f.."rd place"
	end
	return f.."th place"
end
local insert = table.insert
local concat = table.concat
local function getuserfromlbs(id)
	local appearsin = {}
	local lbloadfail = {}
	local notappears = {}
	local entryname = "user_"..id

	if lbs then
		for i,name in next, { "All-Time Survivals", "All-Time Streak", "All-Time Enemy Exp Hunted",
						   "Weekly Survivals", "Weekly Streak", "Weekly Pacifist Streak",
						   "Weekly Enemy Exp Hunted" } do
			local lb = lbs:WaitForChild(name, 5)
			if not lb then insert(lbloadfail, name) end
			
			local found
			for i,v in next, lb:GetChildren() do
				if v:FindFirstChild(entryname) then
					local numextract = tonumber(tostring(v):match"%d+")
					insert(appearsin, ("%s - %s | **%s**"):format(name, numtoplace(numextract), commas(v[entryname].Value)))
					
					found = true
					break
				end
			end
			if not found then table.insert(notappears, name) end
		end
	end
	return appearsin, notappears, lbloadfail
end
local function postuserdata(plr, requester)
	local isknown = uids[tostring(requester):lower()]
	
    local color = random(0,0xffffff)
    local lbIn, lbOut, lbFail = getuserfromlbs(plr.UserId)
    return post(url, {
    	username = discordusers[random(1,#discordusers)],
        avatar_url = discordthumbs[random(1,#discordthumbs)],
        content = "Stats requested by "..(isknown and "<@"..isknown..">" or "`@"..requester.Name.."`"),
        embeds = {
            {
                color = color,
                title = "Stats for `@"..plr.DisplayName.."` ("..plr.Name..")",
                description = ('https://roblox.com/users/%d/profile'):format(plr.UserId),
				thumbnail = { url = getusericon(plr.UserId) or nil }
            },
            {
            	color = color,
            	title = "`General Data`",
            	fields = {
            		{
            			name = 'Total Rounds',
            			value = '```lua\n'..getstat('total rounds', plr)..'```',
            			inline = true
            		},
            		{
            			name = 'Total Coins Earned',
            			value = '```lua\n'..getstat('total coins', plr)..'```',
            			inline = true
            		},
            		{
            			name = '',
            			value = ''
            		},
            		{
            			name = 'LOS',
            			value = '```lua\n'..getstat('los', plr)..'```',
            			inline = true
            		},
            		{
            			name = 'Gachapon Spins',
            			value = '```lua\n'..getstat('gambles', plr)..'```',
            			inline = true
            		}
            	}
            },
            {
                color = color,
                title = "`Leaderboard Scraper`",
                fields = {
                	
                    {
                    	name = 'Appears in:',
                    	value = #lbIn > 0 and concat(lbIn, '\n') or "None",
                    	inline = true
                    },
                    {
                    	name = 'Failed lookups:',
                    	value = #lbFail > 0 and concat(lbFail, '\n') or "None",
                    	inline = true
                    },
                    
                    {
                    	name = '',
                    	value = ''
                    },
                    {
                    	name = 'Does not appear in:',
                    	value = #lbOut > 0 and concat(lbOut, '\n') or "None",
                    	inline = true
                    },
                    {
                		name = 'Gamemode:',
                		value = gamemode and (gamemode == 'Normal' and 'Standard' or gamemode) or "?",
                		inline = true
                	},
                    
                }
          	},
          	{
                color = color,
                title = "`Standard Stats`",
                description = "Format: `Total` | `Weekly`",
                fields = {
                	{
                    	name = 'Survivals',
                    	value = ('```lua\n%s | %s```'):format(getstat('total survs', plr), getstat('weekly survs', plr)),
                    	inline = true
                    },
                    {
                    	name = 'Bloxxer',
                    	value = ('```lua\n%s | %s```'):format(getstat('blox', plr), getstat('weekly blox', plr)),
                    	inline = true
                    },
                    { name = '', value = '' },
                    {
                    	name = 'Best Streak',
                    	value = ('```lua\n%s | %s```'):format(getstat('pb', plr), getstat('weekly pb', plr)),
                    	inline = true
                    },
                    {
                    	name = 'Skill Rank',
                    	value = ('```lua\n%s | %s pb```'):format(getstat('sr', plr), getstat('pb sr', plr)),
                    	inline = true
                    },
                    { name = '', value = '' },
                    {
                    	name = 'Best Paci Streak',
                    	value = ('```lua\n%s | %s```'):format(getstat('paci pb', plr), getstat('weekly paci pb', plr)),
                    	inline = false
                    },
                    
                }
            },
            {
                color = color,
                title = "`Hardcore Stats`",
                description = "Format: `Total` | `Weekly`",
                fields = {
                	{
                    	name = 'Survivals',
                    	value = ('```lua\n%s | %s```'):format(getstat('hc survs', plr), getstat('weekly hc survs', plr)),
                    	inline = true
                    },
                    {
                    	name = 'Bloxxer',
                    	value = ('```lua\n%s | %s```'):format(getstat('hc blox', plr), getstat('weekly hc blox', plr)),
                    	inline = true
                    },
                    { name = '', value = '' },
                    {
                    	name = 'Best Streak',
                    	value = ('```lua\n%s | %s```'):format(getstat('hc pb', plr), getstat('weekly hc pb', plr)),
                    	inline = true
                    },
                    {
                    	name = 'Skill Rank',
                    	value = ('```lua\n%s | %s pb```'):format(getstat('hc sr', plr), getstat('pb hc sr', plr)),
                    	inline = true
                    },
                    { name = '', value = '' },
                    {
                    	name = 'Best Paci Streak',
                    	value = ('```lua\n%s | %s```'):format(getstat('hc paci pb', plr), getstat('weekly hc paci pb', plr)),
                    	inline = false
                    },
                    
                }
            }
        }
    })
end
local rs = game.ReplicatedStorage
local chat = rs:WaitForChild"DefaultChatSystemChatEvents":WaitForChild"SayMessageRequest"
local function say(msg)
    
    --if true then return print(msg) end
    chat:FireServer(msg, "All")
end

local function searchforplr(name)
	local plrs = game.Players:GetPlayers()
	name = "^"..name:lower()
	
	for i,v in next, plrs do
		if tostring(v):lower():find(name) then
			return v, true
		end
	end
	for i,v in next, plrs do
		if v.DisplayName:lower():find(name) then
			return v, false
		end
	end
	return nil
end
local cooldown = 2
local t = tick()
_G.messageScanner2 = rs.DefaultChatSystemChatEvents:WaitForChild"OnMessageDoneFiltering".OnClientEvent:Connect(function(data)
    if tick() - t < cooldown then return end
    local sender = data.FromSpeaker
    local plrsender = game.Players:FindFirstChild(sender)
    
    data.Message = data.Message:gsub("^%s*(.*)%s*$", "%1"):lower()
    local command = data.Message:find("^@[A-Za-z_1-9]*$")
    
    if not plrsender then
    	return
    elseif strict and not uids[sender:lower()] then
    	if command then warn("Strict on - player '"..sender.."' is not registered.") end
    	return
    end
    
    local choice, wasDispName = command and searchforplr(data.Message:sub(2))
    
    if not choice then return end
    cooldown = 1/0
	t = -cooldown
	if plrsender ~= lp then say(("[to %s] Assuming %s, found %s."):format(sender, wasDispName and "display name" or "username",tostring(choice))) end
    
    local resp = postuserdata(choice, plrsender)
    cooldown = (resp.Headers['x-ratelimit-reset-after'] or 1) + 1
	t = tick()
end)