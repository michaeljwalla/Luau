if getgenv().sock then pcall(function() getgenv().sock:Close() end) end
task.wait(0.1)
getgenv().sock = syn.websocket.connect('ws://localhost:3000')

pcall(function() game.CoreGui.SocketControl:Destroy() end)
local lp = game.Players.LocalPlayer

local uis = game:GetService'UserInputService'
local container = Instance.new("ScreenGui", game.CoreGui)
container.Name = 'SocketControl'
local main = Instance.new("TextBox", container)
main.Size = UDim2.new(0,250,0,25)
main.BackgroundColor3 = Color3.new()
main.BorderSizePixel = 0
main.BackgroundTransparency = 0.5
main.TextColor3 = Color3.new(1,1,1)
main.Text = ''
main.Font = 'Gotham'
main.Position = UDim2.new(1,-250,0.5,-main.Size.Y.Offset/2)
main.TextSize = 18
main.Visible = false
local response = Instance.new("TextLabel", main)
response.Size = UDim2.new(1,0,0,100)
response.Position = UDim2.fromOffset(0,main.Size.Y.Offset)
response.BackgroundTransparency = 0.5
response.TextColor3 = Color3.new(1,1,1)
response.BorderSizePixel = 0
response.TextSize = 14
response.TextWrapped = true
response.Font = 'Gotham'
response.TextYAlignment = "Top"
response.Text = "--- Response ---"
if _G.focusLock then _G.focusLock:Disconnect() end
_G.focusLock = uis.InputEnded:Connect(function(key, focused)
    if (focused or key.KeyCode ~= Enum.KeyCode.BackSlash) then return end
    main.Visible = true
    main:CaptureFocus()
end)
main.FocusLost:Connect(function()
    main.Text = main.Text:gsub("^%s*", ""):gsub("%s*$","")
    xpcall(function()
        sock:Send(main.Text)
        main.Visible = false
    end, function(err)
        response.Text = err:gsub("^.*:%d+: ", "")
    end)
    
end)
local dc
dc = sock.OnMessage:Connect(function(msg)
    if not response:IsDescendantOf(game) then dc:Disconnect() return end
    response.Text = "--- Response ---\n\n"..msg.."\n\n"..os.date():match("%d*:%d*:%d*")
    main.Visible = true
    local new
    task.spawn(function()
        main.FocusLost:Wait()
        new = true
    end)
    task.delay(5,function()
        if not new and main.Visible and uis:GetFocusedTextBox() ~= main then main.Visible = false end
    end)
end)

local actual
actual = sock.OnMessage:Connect(function(msg)
    if msg == 'READY' then sock:Send("syncHeal") return end
    if msg:match"^BROADCAST: " then
        msg = msg:gsub("^BROADCAST: ", "")
    end
    
    if msg == 'Equip' and lp.Character and lp.Backpack:FindFirstChild"Darkheart" then
        lp.Backpack.Darkheart.Parent = lp.Character
    elseif msg == 'Activate' and lp.Character then
        local tool = lp.Character:FindFirstChild"Healing Staff"
        if tool then tool:Activate() end
    elseif msg:match"Activate %d+" then
        if lp.Backpack:FindFirstChild'Healing Staff' then lp.Backpack['Healing Staff'].Parent = lp.Character end
        local tool = lp.Character:FindFirstChild"Healing Staff"
        if tool then 
            local time = tonumber(({msg:match"Activate %d+":gsub("Activate ", "")})[1])
            local t = tick()
            print("Activating for "..time.."s")
            while task.wait() and tick() - t <= time and lp.Character and tool.Parent do 
                tool:Activate()
            end
        end
    end
end)