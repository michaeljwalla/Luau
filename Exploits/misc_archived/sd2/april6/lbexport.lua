--defining vars
local insert, date, floor = table.insert, os.date, math.floor
local round, abs = math.round, math.abs

local rs = game:GetService"ReplicatedStorage"
local lbs = rs:WaitForChild"Global"
local usernames = rs:WaitForChild"Usernames"

local http = game:GetService"HttpService"
--defining funcs
local function json(tbl) return http:JSONEncode(tbl) end
local function unjson(str) return http:JSONDecode(str) end

local function commas(num) --lol not optimized
    if not type(num) == 'number' then return "?" end
    local decimal = round(abs(num % 1) * 1e2) --save only 2 decimal places
    num = floor(num)
    local result = tostring(num):reverse():gsub("(%d%d%d)", "%1,"):reverse():gsub("^,", "")
    return decimal > 0 and result.."."..round(decimal) or result
end
    
--enter the key names (in []) into fetchlb() function to retrieve corresponding lb
local nameassigns = {
	["Total Survivals"] = "All-Time Survivals",
	["Best Streak"] = "All-Time Streak",
	["Total Bloxxer"] = "All-Time Enemy Exp Hunted",
	["Weekly Survivals"] = "Weekly Survivals",
	["Weekly Streak"] = "Weekly Streak",
	["Weekly Pacifist Streak"] = "Weekly Pacifist Streak",
	["Weekly Bloxxer"] = "Weekly Enemy Exp Hunted"
}
--identify if the game is currently in standard or hc
local exportmode = rs:WaitForChild"Info":WaitForChild"Gamemode".Value == "Hardcore" and "Hardcore" or "Standard"

--main lb-getter function
local function fetchlb(which) -- <string?> which
	if not which then --get all of them
		local new = {}
		for i,v in next, nameassigns do
			new[i] = fetchlb(i) -- one layer recursive call
		end
		return new
	end

	--make sure lb exists
	local lb = nameassigns[which] and lbs:FindFirstChild(nameassigns[which])
	assert(lb, ("Requested leaderboard '%s' does not exist."):format(tostring(which)))
	
	local new = {}
	for i = 1, 50 do --get first 50 (the lb actually goes up 65, but they dont always load past 50)
		local x = tostring(i)
		if i < 10 then x = "0"..i end --formatting for in-game object lookup

		local format = { --default values in case of error
			Id = -1,
			Name = "?",
			Value = -1
		}
		insert(new, format)

		local result = lb:FindFirstChild("Name"..x)
		result = result and result:FindFirstChildWhichIsA"IntValue" --quit early if something is wrong with the lb (no entry exists)
		if not result then continue end

		local name = result.Name
		format.Id = tonumber(name:match"%d+$") or -1 --lua regex to get the userid from object's name

		-- i will add a way to cache usernames later instead of relying on slow server name updates (which is why all the names are 'Loading...' when new servers r made)
		-- itll be pretty easy im just lazy rn and dont feel like making another table
		format.Name = usernames:FindFirstChild(name) and usernames[name].Value or "?"
		format.Value = ('"%s"'):format(commas(result.Value))--the actual value of the lb entry

		continue
	end
	return new
end

--turn lua table to json file in /workspace
local function exportlbJSON(filename, which) --always has default headers of the gamemode, unix time, and local time of collection
	writefile(tostring(filename)..".json", json{
		Mode = exportmode,
		CollectedTimeUnix = floor(tick()),
		CollectedTimeLocal = date(),
		Leaderboards = not which and fetchlb() or {
			[which] = fetchlb(which)
		}
	})
	return
end

--lua table to csv in /workspace
local function exportlbCSV(filename, which)
	local newcsv = ("Mode,%s\nCollectedTimeUnix,%s\nCollectedTimeLocal,%s"):format(exportmode, floor(tick()), date())--always has default headers of the gamemode, unix time, and local time of collection

	if which then --if a lb was specified
		newcsv = newcsv.."\n\n"..which..",Value,Name,Id\n" --default header

		local f = filename..".csv"
		writefile(f, newcsv) --make the new file in /workspace
		
		local str = ""
		for i,v in next, fetchlb(which) do
			str = str..("%d,%s,%s,https://roblox.com/users/%s\n"):format(i,v.Value,v.Name,v.Id) --csv files are pretty easy all you do to change 'cells' is add a comma
		end
		appendfile(f, str)
	else --otherwise get them all
		local stuff = fetchlb() --gets all
		newcsv = newcsv.."\n\n"
		for i,v in next, nameassigns do --since csv's are horizontal and vertical, you have to write everything on ONE row before moving to the next column
			newcsv = newcsv..i..",Value,Name,Id,," --makes all of the headers for each lb
		end
		
		local f = filename..".csv"
		writefile(f, newcsv.."\n") --into /workspace
		
		local str = ""
		for i = 1, 50 do --get top 50
			for _,v in next, stuff do --get lb spot (i) from each lb
				v = v[i]
				str = str..("%d,%s,%s,https://roblox.com/users/%s,,"):format(i,v.Value,v.Name,v.Id)
			end
			str = str.."\n"
		end
		appendfile(f, str)
	end
	return
end

exportlbCSV("Leaderboards")